<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<!-- 查询驱动列表 -->
<div class="form-container">
    <div class="card-header">
        <h3 class="card-title text-center">驱动管理</h3>
    </div>
    <div class="card-body">
        <div class="grid grid-cols-6 items-center">
            <div id="searchMapping" class="lg:col-span-2 search-wrapper">
                <i class="fa fa-search search-icon"></i>
                <input id="searchKeyword" class="search-input" type="text" maxlength="32" placeholder="搜索驱动名称">
                <span class="search-clear" title="清除">
                    <i class="fa fa-times"></i>
                </span>
            </div>
            <div class="lg:col-span-2"></div>
            <div class="lg:col-span-2 flex items-center justify-end gap-4">
                <button class="btn btn-primary" id="addMappingBtn">
                    <i class="fa fa-plus"></i> 添加
                </button>
            </div>
        </div>
        <table class="table">
            <thead>
            <tr>
                <th></th>
                <th>名称</th>
                <th>数据源</th>
                <th>目标源</th>
                <th>类型</th>
                <th>状态</th>
                <th>结果</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="mappingTableBody">
                <!-- 动态数据 -->
                <tr th:each="mapping, iterStat : ${mappings}" th:if="${mappings != null and !mappings.isEmpty()}">
                    <td th:text="${iterStat.index + 1}">1</td>
                    <td>
                        <div class="d-flex align-center">
                            <i class="fa fa-exchange"></i>
                            <span th:text="${mapping.name}">名称</span>
                        </div>
                    </td>
                    <td th:text="${mapping.sourceConnector != null ? mapping.sourceConnector.name : 'N/A'}">数据源</td>
                    <td th:text="${mapping.targetConnector != null ? mapping.targetConnector.name : 'N/A'}">目标源</td>
                    <td th:text="${mapping.meta != null ? mapping.meta.model : 'N/A'}">类型</td>
                    <td>
                        <span th:if="${mapping?.meta?.state eq 0}" class="label label-default">未运行</span>
                        <span th:if="${mapping?.meta?.state eq 1}" class="label label-success">运行中</span>
                        <span th:if="${mapping?.meta?.state eq 2}" class="label label-default">停止中</span>
                    </td>
                    <td>
                        <span th:if="${mapping?.meta?.total > 0}" th:text="'总数:'+${mapping?.meta.total}" class="label label-default">总数</span>
                        <span th:text="'已完成:'+${mapping?.meta.success}" class="label label-success">已完成数量</span>
                        <span th:if="${mapping?.meta?.fail > 0}" th:text="'失败数量:'+${mapping?.meta.fail}" class="label label-danger">失败数量</span>
                    </td>

                    <td>
                        <div class="flex items-center gap-1">
                            <button class="table-action-btn view" title="编辑" th:data-id="${mapping.id}" onclick="editMapping(this.dataset.id)">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="table-action-btn play mapping-action-btn" th:data-id="${mapping.id}"
                                    th:data-state="${mapping?.meta?.state}"
                                    th:data-running="${mapping?.meta?.state eq 1}"
                                    onclick="testConnector(this.dataset.id)">
                                <i th:class="'fa ' + ${mapping?.meta?.state eq 1 ? 'fa-stop' : 'fa-play'}"
                                   th:title="${mapping?.meta?.state eq 1 ? '停止' : '启动'}"></i>
                            </button>
                            <button class="table-action-btn delete" title="删除" th:data-id="${mapping.id}" onclick="deleteMapping(this.dataset.id)">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <!-- 空数据提示 -->
                <tr th:if="${mappings == null or mappings.isEmpty()}">
                    <td colspan="8" class="text-center">
                        <i class="fa fa-exchange empty-icon"></i>
                        <p class="empty-text">暂无驱动</p>
                        <p class="empty-description">点击"添加"按钮创建第一个驱动</p>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- 分页信息 -->
        <div class="p-5 border-t border-gray-100 flex items-center justify-between" th:if="${mappings != null and !mappings.isEmpty()}">
                <p class="text-sm text-gray-500">共 <span id="totalCount" th:text="${mappings.size()}">0</span> 条，第 <span id="currentPage">1</span> / <span id="totalPages">1</span> 页</p>
                <div class="flex items-center gap-2">
                    <button class="pagination-btn" disabled>
                        <i class="fa fa-angle-left"></i>
                    </button>
                    <button class="pagination-btn active">1</button>
                    <button class="pagination-btn">2</button>
                    <button class="pagination-btn">
                        <i class="fa fa-angle-right"></i>
                    </button>
                </div>
            </div>
    </div>
</div>

<script>
// 同步任务管理页面脚本 - 全局函数定义

// 同步任务列表自动刷新定时器
var mappingListAutoRefreshTimer = null;

// 自动刷新间隔（毫秒），默认5秒
var MAPPING_LIST_REFRESH_INTERVAL = 5000;

// 是否启用自动刷新（如果遇到问题可以设置为false临时禁用）
var ENABLE_AUTO_REFRESH = true;

// 调试模式（设置为true可以看到详细日志）
var MAPPING_LIST_DEBUG = false;

/**
 * 控制台命令：启用调试模式
 * 在浏览器控制台执行：enableMappingDebug()
 */
window.enableMappingDebug = function() {
    MAPPING_LIST_DEBUG = true;
    console.log('[调试] 已启用映射列表调试模式');
};

/**
 * 控制台命令：禁用调试模式
 * 在浏览器控制台执行：disableMappingDebug()
 */
window.disableMappingDebug = function() {
    MAPPING_LIST_DEBUG = false;
    console.log('[调试] 已禁用映射列表调试模式');
};

/**
 * 控制台命令：禁用自动刷新
 * 在浏览器控制台执行：disableAutoRefresh()
 */
window.disableAutoRefresh = function() {
    ENABLE_AUTO_REFRESH = false;
    stopMappingListAutoRefresh();
    console.log('[调试] 已禁用自动刷新');
};

/**
 * 控制台命令：启用自动刷新
 * 在浏览器控制台执行：enableAutoRefresh()
 */
window.enableAutoRefresh = function() {
    ENABLE_AUTO_REFRESH = true;
    startMappingListAutoRefresh();
    console.log('[调试] 已启用自动刷新');
};

/**
 * 控制台命令：查看当前状态
 * 在浏览器控制台执行：getMappingListStatus()
 */
window.getMappingListStatus = function() {
    // console.log('=== 映射列表状态 ===');
    // console.log('自动刷新启用:', ENABLE_AUTO_REFRESH);
    // console.log('调试模式:', MAPPING_LIST_DEBUG);
    // console.log('刷新间隔(秒):', MAPPING_LIST_REFRESH_INTERVAL / 1000);
    // console.log('定时器运行中:', mappingListAutoRefreshTimer !== null);
    // console.log('表格存在:', $('#mappingTable').length > 0);
    // console.log('表格Body存在:', $('#mappingTableBody').length > 0);
    // console.log('当前行数:', $('#mappingTableBody tr').length);
    // console.log('当前页码:', currentPage);
    // console.log('总页数:', totalPages);
    // console.log('====================');
};

// 分页配置
var ITEMS_PER_PAGE = 10; // 每页显示条数
var currentPage = 1; // 当前页码
var totalItems = 0; // 总数据条数
var totalPages = 0; // 总页数

/**
 * 加载同步任务列表
 */
function loadMappingList() {
    // 智能刷新：根据当前页面类型执行相应的刷新操作
    refreshCurrentMappingPage();
}

/**
 * 智能刷新当前页面
 */
function refreshCurrentMappingPage() {
    // 直接检查关键元素是否存在，而不是检查 HTML 内容
    var $mappingTable = $('#mappingTable');
    var $mappingTableBody = $('#mappingTableBody');
    var $mappingAddForm = $('#mappingAddForm');
    var $mappingModifyForm = $('#mappingModifyForm');
    
    // 判断当前是否在同步任务列表页面
    if ($mappingTable.length && $mappingTableBody.length) {
        console.log('[刷新] 检测到列表页面，刷新列表数据');
        // 当前在同步任务列表页面，刷新列表数据（非静默模式，显示成功提示）
        refreshMappingListData(false);
    } else if ($mappingAddForm.length) {
        console.log('[刷新] 检测到添加页面，重新加载添加页面');
        // 当前在添加任务页面，刷新添加页面
        loadAddMappingPage();
    } else if ($mappingModifyForm.length) {
        console.log('[刷新] 检测到编辑页面，重新加载编辑页面');
        // 当前在编辑页面，刷新编辑页面
        var mappingId = $('#mappingId').val();
        if (mappingId) {
            editMapping(mappingId);
        } else {
            loadMappingListPage();
        }
    } else {
        console.log('[刷新] 未检测到已知页面，加载列表页面');
        // 其他情况，默认加载同步任务列表页面
        loadMappingListPage();
    }
}

/**
 * 刷新同步任务列表数据（不重新加载整个页面）
 * @param {boolean} silent - 是否静默刷新（不显示加载提示和成功消息）
 */
function refreshMappingListData(silent) {
    // 默认不是静默刷新
    silent = silent || false;
    
    // ✅ 在发送请求前先检查表格是否存在
    var $targetTableBody = $('#mappingTableBody');
    var $mappingTable = $('#mappingTable');
    
    if ($targetTableBody.length === 0 || $mappingTable.length === 0) {
        console.warn('[刷新数据] 表格元素不存在，无法刷新');
        if (!silent && typeof bootGrowl === 'function') {
            bootGrowl('页面已切换，无法刷新', 'warning');
        }
        return;
    }
    
    // 保存当前页码和搜索条件
    var savedPage = currentPage;
    var searchQuery = $('#searchInput').val();
    
    console.log('[刷新数据] 开始刷新，当前页:', savedPage, '搜索:', searchQuery || '无');
    
    // ✅ 不使用 showLoading()，因为它会清空整个 #mainContent
    // 使用简单的视觉反馈
    if (!silent) {
        // 添加一个半透明遮罩层到表格上
        var $tableWrapper = $('.table-wrapper');
        if ($tableWrapper.length && !$tableWrapper.find('.refreshing-overlay').length) {
            $tableWrapper.css('position', 'relative').append(
                '<div class="refreshing-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; ' +
                'background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10;">' +
                '<div style="text-align: center;"><i class="fa fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color);"></i>' +
                '<p style="margin-top: 8px; color: var(--text-secondary);">刷新中...</p></div></div>'
            );
        }
    }
    
    // 通过AJAX获取最新的同步任务列表数据
    $.ajax({
        url: '/mapping/list',
        type: 'GET',
        success: function(response) {
            console.log('[刷新数据] AJAX请求成功返回');
            
            // ✅ 移除加载遮罩层
            if (!silent) {
                $('.refreshing-overlay').remove();
            }
            
            // 创建一个临时容器来解析HTML
            var $tempDiv = $('<div>').html(response);
            var tableBody = $tempDiv.find('#mappingTableBody');
            
            if (tableBody.length && tableBody.html().trim() !== '') {
                try {
                    // 在更新前再次检查目标表格是否存在（防止在请求过程中页面被切换）
                    var $targetTableBody = $('#mappingTableBody');
                    var $mappingTable = $('#mappingTable');
                    
                    if ($targetTableBody.length === 0 || $mappingTable.length === 0) {
                        console.warn('[刷新数据] 目标表格不存在，停止刷新');
                        stopMappingListAutoRefresh();
                        return;
                    }
                    
                    // 保存当前的 tbody 以便失败时恢复
                    var oldTableBodyHtml = $targetTableBody.html();
                    
                    // 获取新的HTML内容
                    var newTableBodyHtml = tableBody.html();
                    
                    if (MAPPING_LIST_DEBUG) {
                        console.log('[刷新数据] 准备更新表格');
                        console.log('[刷新数据] - 旧内容行数:', $targetTableBody.find('tr').length);
                        console.log('[刷新数据] - 新内容长度:', newTableBodyHtml.length);
                    }
                    
                    // 更新表格内容
                    $targetTableBody.html(newTableBodyHtml);
                    
                    // 验证更新是否成功
                    var updatedHtml = $('#mappingTableBody').html();
                    var $updatedTableBody = $('#mappingTableBody');
                    
                    if (!$updatedTableBody.length || !updatedHtml || updatedHtml.trim() === '') {
                        console.error('[刷新数据] 更新失败，表格body元素丢失或内容为空');
                        console.error('[刷新数据] - tbody存在:', $updatedTableBody.length > 0);
                        console.error('[刷新数据] - 内容长度:', updatedHtml ? updatedHtml.length : 0);
                        
                        // 尝试恢复
                        if ($('#mappingTable').length > 0) {
                            console.log('[刷新数据] 尝试恢复旧内容');
                            $('#mappingTableBody').html(oldTableBodyHtml);
                            bindMappingActionButtons();
                        } else {
                            console.error('[刷新数据] 整个表格都不存在了，停止自动刷新');
                            stopMappingListAutoRefresh();
                        }
                        return;
                    }
                    
                    console.log('[刷新数据] 表格内容已更新，当前行数:', $updatedTableBody.find('tr').length);
                    
                    // 重新绑定启动/停止按钮事件
                    bindMappingActionButtons();
                    
                    // 如果有搜索条件，重新应用搜索
                    if (searchQuery && searchQuery.trim() !== '') {
                        filterMappings(searchQuery);
                    } else {
                        // 重新初始化分页
                        initPagination();
                        
                        // 尝试恢复之前的页码
                        if (savedPage > 1 && savedPage <= totalPages) {
                            goToPage(savedPage);
                        }
                    }
                    
                    // 显示成功提示（仅非静默模式）
                    if (!silent && typeof bootGrowl === 'function') {
                        bootGrowl('数据刷新成功', 'success');
                    }
                    
                    console.log('[刷新数据] 刷新完成');
                } catch (error) {
                    console.error('[刷新数据] 更新过程出错:', error);
                    console.error('[刷新数据] 错误堆栈:', error.stack);
                    // 停止自动刷新，避免持续报错
                    stopMappingListAutoRefresh();
                }
            } else {
                // 如果无法解析响应，且不是静默模式，回退到重新加载整个页面
                console.warn('[刷新数据] 无法解析响应内容，表格数据为空');
                if (!silent) {
                    loadMappingListPage();
                }
            }
        },
        error: function(xhr, status, error) {
            // 移除加载遮罩层
            if (!silent) {
                $('.refreshing-overlay').remove();
            }
            
            // 记录错误信息
            console.error('刷新数据失败:', status, error);
            
            // 显示错误提示（仅非静默模式）
            if (!silent && typeof bootGrowl === 'function') {
                bootGrowl('数据刷新失败，请稍后重试', 'danger');
            }
        }
    });
}

/**
 * 启动同步任务列表自动刷新定时器
 */
function startMappingListAutoRefresh() {
    // 检查是否启用自动刷新
    if (!ENABLE_AUTO_REFRESH) {
        console.log('[自动刷新] 自动刷新功能已禁用');
        return;
    }
    
    // 先清除已存在的定时器
    stopMappingListAutoRefresh();
    
    // 启动新的定时器
    mappingListAutoRefreshTimer = setInterval(function() {
        try {
            // 检查表格是否存在（更准确的判断方法）
            var $mappingTable = $('#mappingTable');
            var $mappingTableBody = $('#mappingTableBody');
            
            if (MAPPING_LIST_DEBUG) {
                console.log('[自动刷新] 检查表格元素:', {
                    tableExists: $mappingTable.length > 0,
                    tableBodyExists: $mappingTableBody.length > 0,
                    currentTime: new Date().toLocaleTimeString()
                });
            }
            
            // 只有当表格存在时才执行刷新
            if ($mappingTable.length && $mappingTableBody.length) {
                if (MAPPING_LIST_DEBUG) {
                    console.log('[自动刷新] 开始静默刷新数据');
                }
                // 静默刷新（不显示加载提示和成功消息）
                refreshMappingListData(true);
            } else {
                // 如果表格不存在，说明已经离开列表页面，停止定时器
                console.log('[自动刷新] 表格元素不存在，停止自动刷新');
                stopMappingListAutoRefresh();
            }
        } catch (e) {
            // 如果出现错误，停止定时器
            console.error('[自动刷新] 出错:', e);
            stopMappingListAutoRefresh();
        }
    }, MAPPING_LIST_REFRESH_INTERVAL);
    
    if (MAPPING_LIST_DEBUG) {
        console.log('[自动刷新] 已启动，刷新间隔: ' + (MAPPING_LIST_REFRESH_INTERVAL / 1000) + '秒');
    }
}

/**
 * 停止同步任务列表自动刷新定时器
 */
function stopMappingListAutoRefresh() {
    if (mappingListAutoRefreshTimer !== null) {
        clearInterval(mappingListAutoRefreshTimer);
        mappingListAutoRefreshTimer = null;
        if (MAPPING_LIST_DEBUG) {
            console.log('[自动刷新] 已停止');
        }
    }
}

/**
 * 动态加载添加任务页面
 */
function loadAddMappingPage() {
    // 停止自动刷新定时器
    stopMappingListAutoRefresh();
    
    // 使用doLoader函数动态加载添加任务页面
    if (typeof doLoader === 'function') {
        doLoader('/mapping/pageAdd', 0);
    } else {
        // 如果没有doLoader函数，使用jQuery load方法
        loadAddMappingPageDirectly();
    }
}

/**
 * 直接加载添加任务页面
 */
function loadAddMappingPageDirectly() {
    // 使用统一的内容区域
    var contentDiv = $('#mainContent');
    if (contentDiv.length) {
        // 显示加载状态
        showLoading();
        
        // 加载添加任务页面内容
        contentDiv.load('/mapping/pageAdd', function(response, status, xhr) {
            hideLoading();
            
            if (status === 'success') {
                // 初始化添加任务页面的脚本
                initAddMappingPage();
            } else {
                bootGrowl('加载添加任务页面失败，请稍后重试', 'danger');
            }
        });
    }
}

/**
 * 初始化添加任务页面
 */
function initAddMappingPage() {
    // 重写backIndexPage函数，使其返回到同步任务列表页面
    window.backIndexPage = function() {
        loadMappingListPage();
    };

    // 绑定返回按钮事件
    $('#mappingBackBtn').off('click').on('click', function() {
        // 返回到同步任务列表页面
        loadMappingListPage();
    });

    // 绑定保存按钮事件
    $('#mappingSubmitBtn').off('click').on('click', function() {
        submitMappingForm();
    });
}

/**
 * 加载同步任务列表页面
 */
function loadMappingListPage() {
    // 使用统一的内容区域
    var contentDiv = $('#mainContent');
    if (contentDiv.length) {
        showLoading();
        
        // 加载同步任务列表页面内容
        contentDiv.load('/mapping/list', function(response, status, xhr) {
            hideLoading();
            
            if (status === 'success') {
                // 重新初始化同步任务列表页面的脚本
                initMappingListPage();
            } else {
                bootGrowl('加载同步任务列表页面失败，请稍后重试', 'danger');
            }
        });
    }
}

/**
 * 初始化同步任务列表页面
 */
function initMappingListPage() {
    // 先解绑事件，避免重复绑定
    $('#addMappingBtn').off('click');

    $('#refreshBtn').off('click');
    $('#searchInput').off('input');
    $('#prevBtn').off('click');
    $('#nextBtn').off('click');
    $('.mapping-action-btn').off('click');
    
    // 重新绑定事件
    $('#addMappingBtn').on('click', function() {
        loadAddMappingPage();
    });

    $('#refreshBtn').on('click', function() {
        console.log('[刷新按钮] 点击刷新按钮');
        // 检查是否在列表页面
        var $mappingTable = $('#mappingTable');
        var $mappingTableBody = $('#mappingTableBody');
        
        if ($mappingTable.length && $mappingTableBody.length) {
            // 在列表页面，直接刷新数据（非静默模式）
            console.log('[刷新按钮] 刷新列表数据');
            refreshMappingListData(false);
        } else {
            // 不在列表页面，使用智能刷新
            console.log('[刷新按钮] 使用智能刷新');
            loadMappingList();
        }
    });

    $('#searchInput').on('input', function() {
        var query = $(this).val();
        filterMappings(query);
    });

    // 绑定启动/停止按钮事件
    bindMappingActionButtons();
    
    // 绑定分页按钮事件
    $('#prevBtn').on('click', function() {
        prevPage();
    });
    
    $('#nextBtn').on('click', function() {
        nextPage();
    });
    
    // 初始化分页
    initPagination();
    
    // 启动自动刷新定时器
    startMappingListAutoRefresh();
}

/**
 * 绑定启动/停止按钮事件
 */
function bindMappingActionButtons() {
    // 先解绑，避免重复绑定
    $('.mapping-action-btn').off('click');
    
    // 重新绑定
    $('.mapping-action-btn').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var id = $(this).data('id');
        var isRunning = $(this).data('running');
        
        if (isRunning === true || isRunning === 'true' || isRunning === '1' || isRunning === 1) {
            stopMapping(id);
        } else {
            startMapping(id);
        }
    });
}

/**
 * 提交任务表单
 */
function submitMappingForm() {
    var form = $('#mappingAddForm');
    
    // 使用现有的表单验证
    if (typeof form.formValidate === 'function' && form.formValidate() === true) {
        var data = form.serializeJson();
        
        // 显示提交状态
        var submitBtn = $('#mappingSubmitBtn');
        var originalText = submitBtn.html();
        submitBtn.html('<i class="fa fa-spinner fa-spin"></i> 保存中...').prop('disabled', true);
        
        // 使用现有的doPoster函数提交表单
        if (typeof doPoster === 'function') {
            doPoster("/mapping/add", data, function(response) {
                submitBtn.html(originalText).prop('disabled', false);
                
                if (response.success === true) {
                    if (typeof bootGrowl === 'function') {
                        bootGrowl("新增任务成功!", "success");
                    } else {
                        alert('任务添加成功');
                    }
                    // 返回到同步任务列表页面
                    loadMappingListPage();
                } else {
                    if (typeof bootGrowl === 'function') {
                        bootGrowl(response.resultValue, "danger");
                    } else {
                        alert('添加失败: ' + response.resultValue);
                    }
                }
            });
        }
    }
}

/**
 * 筛选同步任务
 */
function filterMappings(query) {
    // 获取所有表格行（排除空数据提示行）
    var $rows = $('#mappingTableBody tr').not(':contains("暂无同步任务")');
    
    // 如果没有搜索条件，显示所有行并重新分页
    if (!query || query.trim() === '') {
        $rows.each(function() {
            $(this).data('filtered', false);
        });
        initPagination();
        return;
    }
    
    // 标记符合条件的行
    $rows.each(function() {
        var $row = $(this);
        var name = $row.find('td:nth-child(2) span').text().toLowerCase();
        var matches = name.indexOf(query.toLowerCase()) !== -1;
        
        // 使用 data 属性标记是否被过滤
        $row.data('filtered', !matches);
    });
    
    // 重新计算分页（只包含未被过滤的行）
    var $visibleRows = $rows.filter(function() {
        return !$(this).data('filtered');
    });
    
    totalItems = $visibleRows.length;
    totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
    // 重置到第一页
    currentPage = 1;
    
    // 隐藏所有行
    $rows.hide();
    
    // 显示当前页的数据
    if (totalItems > 0) {
        $visibleRows.slice(0, ITEMS_PER_PAGE).show();
    }
    
    // 更新分页控件
    updatePaginationDisplay();
    updatePaginationControls();
}

/**
 * 更新分页信息
 */
function updateMappingPaginationInfo() {
    var visibleRows = $('#mappingTableBody tr:visible').length;
    $('#totalCount').text(visibleRows);
    
    // 重新计算分页
    initPagination();
}

/**
 * 初始化分页
 */
function initPagination() {
    // 获取所有可见的数据行（排除空数据提示行）
    var $rows = $('#mappingTableBody tr').not(':contains("暂无同步任务")');
    totalItems = $rows.length;
    
    // 计算总页数
    totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
    // 如果当前页超过总页数，重置到第一页
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = 1;
    }
    
    // 如果没有数据，设置当前页为1
    if (totalItems === 0) {
        currentPage = 1;
        totalPages = 1;
    }
    
    // 显示当前页的数据
    showPage(currentPage);
    
    // 更新分页控件
    updatePaginationControls();
}

/**
 * 显示指定页的数据
 * @param {number} page - 页码（从1开始）
 */
function showPage(page) {
    // 验证页码
    if (page < 1) page = 1;
    if (page > totalPages && totalPages > 0) page = totalPages;
    
    currentPage = page;
    
    // 获取所有数据行（排除空数据提示行）
    var $rows = $('#mappingTableBody tr').not(':contains("暂无同步任务")');
    
    // 计算当前页的数据范围
    var startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    var endIndex = startIndex + ITEMS_PER_PAGE;
    
    // 隐藏所有行
    $rows.hide();
    
    // 只显示当前页的行
    $rows.slice(startIndex, endIndex).show();
    
    // 更新分页信息显示
    updatePaginationDisplay();
}

/**
 * 更新分页信息显示
 */
function updatePaginationDisplay() {
    $('#totalCount').text(totalItems);
    $('#currentPage').text(currentPage);
    $('#totalPages').text(totalPages > 0 ? totalPages : 1);
}

/**
 * 更新分页控件（按钮状态和页码按钮）
 */
function updatePaginationControls() {
    // 更新上一页按钮状态
    if (currentPage <= 1) {
        $('#prevBtn').prop('disabled', true).addClass('disabled');
    } else {
        $('#prevBtn').prop('disabled', false).removeClass('disabled');
    }
    
    // 更新下一页按钮状态
    if (currentPage >= totalPages) {
        $('#nextBtn').prop('disabled', true).addClass('disabled');
    } else {
        $('#nextBtn').prop('disabled', false).removeClass('disabled');
    }
    
    // 生成页码按钮
    generatePageButtons();
}

/**
 * 生成页码按钮
 */
function generatePageButtons() {
    var $pageContainer = $('.pagination-page');
    $pageContainer.empty();
    
    // 如果总页数小于等于7，显示所有页码
    if (totalPages <= 7) {
        for (var i = 1; i <= totalPages; i++) {
            $pageContainer.append(createPageButton(i));
        }
    } else {
        // 总页数大于7，显示省略号
        // 始终显示第一页
        $pageContainer.append(createPageButton(1));
        
        // 计算显示范围
        var startPage, endPage;
        
        if (currentPage <= 3) {
            // 当前页在前面，显示 1 2 3 4 5 ... 最后页
            startPage = 2;
            endPage = 5;
            for (var i = startPage; i <= endPage; i++) {
                $pageContainer.append(createPageButton(i));
            }
            $pageContainer.append('<span class="pagination-ellipsis">...</span>');
            $pageContainer.append(createPageButton(totalPages));
        } else if (currentPage >= totalPages - 2) {
            // 当前页在后面，显示 1 ... 倒数5 倒数4 倒数3 倒数2 最后页
            $pageContainer.append('<span class="pagination-ellipsis">...</span>');
            startPage = totalPages - 4;
            endPage = totalPages;
            for (var i = startPage; i <= endPage; i++) {
                $pageContainer.append(createPageButton(i));
            }
        } else {
            // 当前页在中间，显示 1 ... 当前页-1 当前页 当前页+1 ... 最后页
            $pageContainer.append('<span class="pagination-ellipsis">...</span>');
            for (var i = currentPage - 1; i <= currentPage + 1; i++) {
                $pageContainer.append(createPageButton(i));
            }
            $pageContainer.append('<span class="pagination-ellipsis">...</span>');
            $pageContainer.append(createPageButton(totalPages));
        }
    }
}

/**
 * 创建页码按钮
 * @param {number} page - 页码
 * @returns {jQuery} 页码按钮元素
 */
function createPageButton(page) {
    var $btn = $('<button class="pagination-page-btn">' + page + '</button>');
    
    // 设置当前页的激活状态
    if (page === currentPage) {
        $btn.addClass('active');
    }
    
    // 绑定点击事件
    $btn.on('click', function() {
        goToPage(page);
    });
    
    return $btn;
}

/**
 * 跳转到指定页
 * @param {number} page - 目标页码
 */
function goToPage(page) {
    if (page < 1 || page > totalPages) return;
    if (page === currentPage) return;
    
    currentPage = page;
    showPage(currentPage);
    updatePaginationControls();
}

/**
 * 上一页
 */
function prevPage() {
    if (currentPage > 1) {
        goToPage(currentPage - 1);
    }
}

/**
 * 下一页
 */
function nextPage() {
    if (currentPage < totalPages) {
        goToPage(currentPage + 1);
    }
}

// 页面初始化
$(document).ready(function() {
    // 添加任务按钮点击事件 - 动态加载添加任务页面
    $('#addMappingBtn').on('click', function() {
        loadAddMappingPage();
    });

    // 刷新按钮点击事件
    $('#refreshBtn').on('click', function() {
        console.log('[刷新按钮] 点击刷新按钮（document.ready）');
        // 检查是否在列表页面
        var $mappingTable = $('#mappingTable');
        var $mappingTableBody = $('#mappingTableBody');
        
        if ($mappingTable.length && $mappingTableBody.length) {
            // 在列表页面，直接刷新数据（非静默模式）
            console.log('[刷新按钮] 刷新列表数据');
            refreshMappingListData(false);
        } else {
            // 不在列表页面，使用智能刷新
            console.log('[刷新按钮] 使用智能刷新');
            loadMappingList();
        }
    });

    // 搜索框输入事件
    $('#searchInput').on('input', function() {
        var query = $(this).val();
        filterMappings(query);
    });

    // 绑定启动/停止按钮事件
    bindMappingActionButtons();
    
    // 绑定分页按钮事件
    $('#prevBtn').on('click', function() {
        prevPage();
    });
    
    $('#nextBtn').on('click', function() {
        nextPage();
    });
    
    // 初始化分页
    initPagination();
    
    // 启动自动刷新定时器
    startMappingListAutoRefresh();
});

// 页面卸载时清除定时器
$(window).on('beforeunload', function() {
    stopMappingListAutoRefresh();
});

/**
 * 编辑同步任务 - 动态加载编辑页面
 */
function editMapping(id) {
    // 停止自动刷新定时器
    stopMappingListAutoRefresh();
    
    // 使用统一的内容区域
    var contentDiv = $('#mainContent');
    if (contentDiv.length) {
        showLoading();
        
        // 加载编辑页面内容
        contentDiv.load('/mapping/page/edit?id=' + id, function(response, status, xhr) {
            hideLoading();
            
            if (status === 'success') {
                // 初始化编辑页面的脚本
                initMappingEditPage();
            } else {
                bootGrowl('加载编辑页面失败，请稍后重试', 'danger');
            }
        });
    }
}

/**
 * 初始化同步任务编辑页面
 */
function initMappingEditPage() {
    console.log('[initMappingEditPage] 开始初始化编辑页面');
    
    // 重写backIndexPage函数，使其返回到同步任务列表页面
    window.backIndexPage = function() {
        loadMappingListPage();
    };

    // 使用 setTimeout 确保 DOM 完全渲染后再初始化
    setTimeout(function() {
        console.log('[initMappingEditPage] 延迟初始化开始');
        
        // 绑定返回按钮事件（先检查元素是否存在）
        var $backBtn = $('#mappingBackBtn');
        if ($backBtn.length) {
            $backBtn.off('click').on('click', function() {
                loadMappingListPage();
            });
            console.log('[initMappingEditPage] 返回按钮已绑定');
        }

        // 绑定保存按钮事件（先检查元素是否存在）
        var $submitBtn = $('#mappingSubmitBtn');
        if ($submitBtn.length) {
            $submitBtn.off('click').on('click', function() {
                var $form = $("#mappingModifyForm");
                if ($form.length && typeof $form.formValidate === 'function' && $form.formValidate() === true) {
                    var data = $form.serializeJson();
                    submitMappingEditForm(data);
                }
            });
            console.log('[initMappingEditPage] 保存按钮已绑定');
        }

        // 绑定同步方式切换事件
        if (typeof bindMappingModelChange === 'function') {
            bindMappingModelChange();
            console.log('[initMappingEditPage] bindMappingModelChange 已调用');
        }
        
        // 绑定删除表映射事件
        if (typeof bindMappingTableGroupCheckBoxClick === 'function') {
            bindMappingTableGroupCheckBoxClick();
            console.log('[initMappingEditPage] bindMappingTableGroupCheckBoxClick 已调用');
        }

        // 绑定表关系点击事件
        if (typeof bindMappingTableGroupListClick === 'function') {
            bindMappingTableGroupListClick();
            console.log('[initMappingEditPage] bindMappingTableGroupListClick 已调用');
        }
        
        // 绑定下拉选择事件自动匹配相似表事件
        if (typeof bindTableSelect === 'function') {
            bindTableSelect();
            console.log('[initMappingEditPage] bindTableSelect 已调用');
        }
        
        // 绑定多值输入框事件
        if (typeof initMultipleInputTags === 'function') {
            initMultipleInputTags();
            console.log('[initMappingEditPage] initMultipleInputTags 已调用');
        }
        
        // 绑定删除表关系点击事件
        if (typeof bindMappingTableGroupDelClick === 'function') {
            bindMappingTableGroupDelClick();
            console.log('[initMappingEditPage] bindMappingTableGroupDelClick 已调用');
        }
        
        // 绑定刷新数据表按钮点击事件
        if (typeof bindRefreshTablesClick === 'function') {
            bindRefreshTablesClick();
            console.log('[initMappingEditPage] bindRefreshTablesClick 已调用');
        }
        
        // 绑定下拉过滤按钮点击事件
        if (typeof bindMultipleSelectFilterBtnClick === 'function') {
            bindMultipleSelectFilterBtnClick();
            console.log('[initMappingEditPage] bindMultipleSelectFilterBtnClick 已调用');
        }
        
        console.log('[initMappingEditPage] 延迟初始化完成');
    }, 100); // 延迟 100ms，确保 DOM 和脚本都已加载
}

/**
 * 提交编辑同步任务表单
 */
function submitMappingEditForm(data) {
    // 显示提交状态
    var submitBtn = $('#mappingSubmitBtn');
    var originalText = submitBtn.html();
    submitBtn.html('<i class="fa fa-spinner fa-spin"></i> 保存中...').prop('disabled', true);
    
    // 使用现有的doPoster函数提交表单
    if (typeof doPoster === 'function') {
        doPoster("/mapping/edit", data, function(response) {
            submitBtn.html(originalText).prop('disabled', false);
            
            if (response.success === true) {
                if (typeof bootGrowl === 'function') {
                    bootGrowl("修改驱动成功!", "success");
                } else {
                    alert('修改驱动成功');
                }
                // 返回到同步任务列表页面
                loadMappingListPage();
            } else {
                if (typeof bootGrowl === 'function') {
                    bootGrowl(response.resultValue, "danger");
                } else {
                    alert('修改失败: ' + response.resultValue);
                }
            }
        });
    } else {
        // 如果没有doPoster函数，使用jQuery Ajax
        $.ajax({
            url: '/mapping/edit',
            type: 'POST',
            data: data,
            success: function(response) {
                submitBtn.html(originalText).prop('disabled', false);
                
                if (response.success) {
                    if (typeof bootGrowl === 'function') {
                        bootGrowl("修改驱动成功!", "success");
                    } else {
                        alert('修改驱动成功');
                    }
                    loadMappingListPage();
                } else {
                    if (typeof bootGrowl === 'function') {
                        bootGrowl(response.resultValue || response.message, "danger");
                    } else {
                        alert('修改失败: ' + (response.resultValue || response.message));
                    }
                }
            },
            error: function() {
                submitBtn.html(originalText).prop('disabled', false);
                if (typeof bootGrowl === 'function') {
                    bootGrowl('修改失败，请稍后重试', 'danger');
                } else {
                    alert('修改失败，请稍后重试');
                }
            }
        });
    }
}

/**
 * 启动任务
 */
function startMapping(id) {
    // 显示加载状态
    var btn = event.target.closest('.action-btn');
    var originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 启动中...';
    btn.disabled = true;

    // 调用后端API启动任务
    $.ajax({
        url: '/mapping/start',
        type: 'POST',
        data: { id: id },
        success: function(response) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            if (response.success) {
                if (typeof bootGrowl === 'function') {
                    bootGrowl('任务启动成功', 'success');
                } else {
                    alert('任务启动成功');
                }
                // 刷新列表
                loadMappingListPage();
            } else {
                if (typeof bootGrowl === 'function') {
                    bootGrowl('任务启动失败: ' + response.resultValue, 'danger');
                } else {
                    alert('任务启动失败: ' + response.resultValue);
                }
            }
        },
        error: function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('任务启动失败，请稍后重试');
        }
    });
}

/**
 * 停止任务
 */
function stopMapping(id) {
    // 显示加载状态
    var btn = event.target.closest('.action-btn');
    var originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 停止中...';
    btn.disabled = true;

    // 调用后端API停止任务
    $.ajax({
        url: '/mapping/stop',
        type: 'POST',
        data: { id: id },
        success: function(response) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            if (response.success) {
                if (typeof bootGrowl === 'function') {
                    bootGrowl('任务停止成功', 'success');
                } else {
                    alert('任务停止成功');
                }
                // 刷新列表
                loadMappingListPage();
            } else {
                if (typeof bootGrowl === 'function') {
                    bootGrowl('任务停止失败: ' + response.resultValue, 'danger');
                } else {
                    alert('任务停止失败: ' + response.resultValue);
                }
            }
        },
        error: function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('任务停止失败，请稍后重试');
        }
    });
}

/**
 * 删除同步任务
 */
function deleteMapping(id) {
    if (confirm('确定要删除这个同步任务吗？删除后无法恢复。')) {
        // 调用后端API删除任务
        $.ajax({
            url: '/mapping/remove',
            type: 'POST',
            data: { id: id },
            success: function(response) {
                if (response.success) {
                    if (typeof bootGrowl === 'function') {
                        bootGrowl('删除成功', 'success');
                    } else {
                        alert('删除成功');
                    }
                    // 刷新列表
                    loadMappingListPage();
                } else {
                    if (typeof bootGrowl === 'function') {
                        bootGrowl('删除失败: ' + response.resultValue, 'danger');
                    } else {
                        alert('删除失败: ' + response.resultValue);
                    }
                }
            },
            error: function() {
                alert('删除失败，请稍后重试');
            }
        });
    }
}

// ============ 编辑页面辅助函数（从 mapping/edit.js 移植） ============

/**
 * 刷新编辑页面
 */
function refreshMappingEditPage(id) {
    editMapping(id);
}

/**
 * 绑定修改驱动同步方式切换事件（备用定义，优先使用edit.js中的实现）
 */
function bindMappingModelChange() {
    var $mappingModelChange = $("#mappingModelChange");
    var $radio = $mappingModelChange.find('input:radio[type="radio"]');
    
    // 使用原生 change 事件替代 iCheck
    $radio.on('change', function (event) {
        var $form = $("#mappingModifyForm");
        if ($form.formValidate() == true) {
            var data = $form.serializeJson();
            doPoster("/mapping/edit", data, function (response) {
                if (response.success == true) {
                    refreshMappingEditPage($("#mappingId").val());
                } else {
                    bootGrowl(response.resultValue, "danger");
                }
            });
        }
    });

    // 渲染选择radio配置
    var $value = $mappingModelChange.find('input[type="radio"]:checked').val();
    // 显示驱动编辑配置（全量/增量）
    var $full = $("#mappingFullConfig");
    var $increment = $("#mappingIncrementConfig");
    if ('full' == $value) {
        $increment.addClass("hidden");
        $full.removeClass("hidden");
    } else {
        $full.addClass("hidden");
        $increment.removeClass("hidden");
    }
}

/**
 * 绑定删除表关系复选框事件（备用定义，优先使用edit.js中的实现）
 */
function bindMappingTableGroupCheckBoxClick() {
    var $checkboxAll = $('.tableGroupCheckboxAll');
    var $checkbox = $('.tableGroupCheckbox');
    var $delBtn = $("#tableGroupDelBtn");
    
    // 全选复选框事件
    $checkboxAll.on('change', function (event) {
        var isChecked = $(this).prop('checked');
        $checkbox.prop('checked', isChecked);
        $delBtn.prop('disabled', getCheckedBoxSize($checkbox).length < 1);
    });

    // 单个复选框事件
    $checkbox.on('change', function (event) {
        // 更新全选复选框状态
        var allChecked = $checkbox.length === $checkbox.filter(':checked').length;
        $checkboxAll.prop('checked', allChecked);
        
        // 更新删除按钮状态
        $delBtn.prop('disabled', getCheckedBoxSize($checkbox).length < 1);
    });
    
    // 初始化删除按钮状态
    $delBtn.prop('disabled', getCheckedBoxSize($checkbox).length < 1);
}

/**
 * 获取选择的CheckBox[value]
 */
function getCheckedBoxSize($checkbox) {
    var checked = [];
    $checkbox.each(function() {
        if ($(this).prop('checked')) {
            checked.push($(this).val());
        }
    });
    return checked;
}

/**
 * 绑定表关系点击事件（备用定义，优先使用edit.js中的实现）
 */
function bindMappingTableGroupListClick() {
    var $tableGroupList = $("#tableGroupList");
    $tableGroupList.unbind("click");
    $tableGroupList.find("tr").bind('click', function () {
        // 动态加载表组编辑页面
        if (typeof doLoader === 'function') {
            doLoader('/tableGroup/page/editTableGroup?id=' + $(this).attr("id"));
        }
    });

    // 绑定表格拖拽事件（使用原生 HTML5 拖拽 API）
    var rows = $tableGroupList.find("tr");
    rows.each(function() {
        var row = $(this)[0];
        row.setAttribute('draggable', 'true');
        
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('dragleave', handleDragLeave);
        row.addEventListener('drop', handleDrop);
    });
    
    var dragSrcEl = null;
    
    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.classList.add('dragging');
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        var rows = $tableGroupList.find('tr');
        rows.removeClass('drag-over');
        
        // 更新排序
        var newData = [];
        rows.each(function () {
            newData.push($(this).attr('id'));
        });
        $("#sortedTableGroupIds").val(newData.join('|'));
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        if (dragSrcEl !== this) {
            var srcIndex = $(dragSrcEl).index();
            var destIndex = $(this).index();
            
            if (srcIndex < destIndex) {
                $(this).after(dragSrcEl);
            } else {
                $(this).before(dragSrcEl);
            }
        }
        
        this.classList.remove('drag-over');
        return false;
    }
}

/**
 * 绑定下拉选择事件自动匹配相似表事件（备用定义，优先使用edit.js中的实现）
 */
function bindTableSelect() {
    const $sourceSelect = $("#sourceTable");
    const $targetSelect = $("#targetTable");
    
    // 初始化多选下拉框
    if (typeof initMultiSelect === 'function') {
        // 初始化数据源表选择器，联动到目标源表
        initMultiSelect('sourceTableWrapper', {
            linkTo: 'targetTableWrapper',
            onSelectChange: function() {
                // 选择变化时的回调
            }
        });
        
        // 初始化目标源表选择器
        initMultiSelect('targetTableWrapper', {
            linkTo: null,
            onSelectChange: function() {
                // 选择变化时的回调
            }
        });
    }
    
    bindMappingTableGroupAddClick($sourceSelect, $targetSelect);
}

/**
 * 绑定下拉过滤按钮点击事件（备用定义，优先使用edit.js中的实现）
 */
function bindMultipleSelectFilterBtnClick() {
    // 新的多选下拉框已经内置了"取消过滤"和"过滤"按钮
    // 无需额外添加，但保留此函数以向后兼容
}

/**
 * 绑定新增表关系点击事件（备用定义，优先使用edit.js中的实现）
 */
function bindMappingTableGroupAddClick($sourceSelect, $targetSelect) {
    let $addBtn = $("#tableGroupAddBtn");
    $addBtn.unbind("click");
    $addBtn.bind('click', function () {
        let m = {};
        m.mappingId = $(this).attr("mappingId");
        // 获取选中的值（兼容新的多选下拉框）
        m.sourceTable = $sourceSelect.val();
        m.targetTable = $targetSelect.val();
        if (undefined == m.sourceTable) {
            bootGrowl("请选择数据源表", "danger");
            return;
        }
        if (undefined == m.targetTable) {
            bootGrowl("请选择目标源表", "danger");
            return;
        }

        let sLen = m.sourceTable.length;
        let tLen = m.targetTable.length;
        if (sLen < 1) {
            bootGrowl("请选择数据源表", "danger");
            return;
        }
        if (tLen < 1) {
            bootGrowl("请选择目标源表", "danger");
            return;
        }
        if (sLen != tLen) {
            bootGrowl("表映射关系数量不一致，请检查源表和目标表关系", "danger");
            return;
        }

        m.sourceTable = m.sourceTable.join('|');
        m.targetTable = m.targetTable.join('|');
        m.sourceTablePK = $("#sourceTablePK").val();
        m.targetTablePK = $("#targetTablePK").val();

        doPoster("/tableGroup/add", m, function (data) {
            if (data.success == true) {
                bootGrowl("新增映射关系成功!", "success");
                refreshMappingEditPage(m.mappingId);
            } else {
                bootGrowl(data.resultValue, "danger");
                if (data.status == 400) {
                    refreshMappingEditPage(m.mappingId);
                }
            }
        });
    });
}

/**
 * 绑定删除表关系点击事件
 */
function bindMappingTableGroupDelClick() {
    $("#tableGroupDelBtn").click(function () {
        var ids = getCheckedBoxSize($(".tableGroupCheckbox"));
        if (ids.length > 0) {
            var $mappingId = $(this).attr("mappingId");
            doPoster("/tableGroup/remove", {"mappingId": $mappingId, "ids" : ids.join()}, function (data) {
                if (data.success == true) {
                    bootGrowl("删除映射关系成功!", "success");
                    refreshMappingEditPage($mappingId);
                } else {
                    bootGrowl(data.resultValue, "danger");
                }
            });
        }
    });
}

/**
 * 修改驱动名称
 */
function mappingModifyName() {
    var $name = $("#mappingModifyName");
    var tmp = $name.text();
    $name.text("");
    $name.append("<input type='text'/>");
    var $input = $name.find("input");
    $input.focus().val(tmp);
    $input.blur(function() {
        $name.text($(this).val());
        $("#mappingModifyForm input[name='name']").val($(this).val());
        $input.unbind();
    });
}

/**
 * 绑定刷新表事件
 */
function bindRefreshTablesClick() {
    let $refreshBtn = $("#refreshTableBtn");
    $refreshBtn.bind('click', function() {
        let id = $(this).attr("tableGroupId");
        doPoster("/mapping/refreshTables", {'id': id}, function (data) {
            if (data.success === true) {
                bootGrowl("刷新表成功!", "success");
                refreshMappingEditPage(id);
            } else {
                bootGrowl(data.resultValue, "danger");
            }
        });
    });
}
</script>

</html>

