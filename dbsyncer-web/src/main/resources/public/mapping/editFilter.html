<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<div th:fragment="content">
    <!-- 过滤条件标题 -->
    <p><i class="fa fa-filter text-warning"></i> 过滤条件</p>

    <!-- 第一行：组合、数据源表字段、条件 -->
    <div class="grid grid-cols-3">
        <!-- 组合 -->
        <div class="form-item">
            <label class="form-label">组合
                <i class="fa fa-question-circle text-tertiary" title="sql与and,or互斥，如果切换sql，将自动删除当前的条件，反之也会删除"></i>
            </label>
            <div class="form-control-area">
                <select id="conditionOperation" class="form-control">
                    <!-- 全局页面 -->
                    <option th:if="${tableGroup} == null" th:each="o,s:${condition?.operation}" 
                            th:value="${o?.name}" th:text="${o?.name}" th:title="${o?.message}" 
                            th:selected="${mapping?.filter.size() gt 0 and mapping?.filter[0].operation eq 'sql'}"/>
                    <!-- 表映射关系页面 -->
                    <option th:if="${tableGroup} != null" th:each="o,s:${condition?.operation}" 
                            th:value="${o?.name}" th:text="${o?.name}" th:title="${o?.message}" 
                            th:selected="${tableGroup?.filter.size() gt 0 and tableGroup?.filter[0].operation eq 'sql'}"/>
                </select>
            </div>
        </div>

        <!-- 数据源表字段 -->
        <div class="form-item">
            <label class="form-label">数据源表字段</label>
            <div class="form-control-area">
                <select id="conditionSourceField" class="form-control">
                    <!-- 数据源表公共字段 -->
                    <option th:if="${tableGroup} == null" th:each="c,s:${mapping?.sourceColumn}" 
                            th:value="${c?.name}" th:text="${c?.name} +' (' + ${c?.typeName} +')'" />
                    <!-- 数据源表字段 -->
                    <option th:each="c,s:${tableGroup?.sourceTable?.column}" 
                            th:value="${c?.name}" th:text="${c?.name} +' (' + ${c?.typeName} +')'" />
                </select>
            </div>
        </div>

        <!-- 条件 -->
        <div class="form-item">
            <label class="form-label">条件</label>
            <select id="conditionFilter" class="form-control">
                <option th:each="f,s:${condition?.filter}" th:value="${f?.name}" th:text="${f?.name}" />
            </select>
        </div>
    </div>

    <!-- 第二行：参数、系统参数、添加按钮 -->
    <div class="grid grid-cols-3 mt-4">
        <!-- 参数 -->
        <div class="form-item">
            <label class="form-label">参数</label>
            <input id="conditionArg" class="form-control" placeholder="请输入参数" />
        </div>

        <!-- 系统参数 -->
        <div class="form-item">
            <label class="form-label">系统参数</label>
            <select id="systemArg" class="form-control">
                <!-- 数据源表字段 -->
                <option th:each="f,s:${condition?.quartzFilter}" th:value="${f?.type}" th:text="${f?.type}" />
            </select>
        </div>

        <!-- 添加按钮 -->
        <div class="flex items-center justify-end">
            <button id="conditionAdd" type="button" class="btn btn-info">
                <i class="fa fa-plus"></i> 添加
            </button>
        </div>
    </div>

    <!-- 条件列表表格 -->
    <table id="conditionTable" class="table">
        <thead>
            <tr>
                <th>组合</th>
                <th>数据源表字段</th>
                <th>条件</th>
                <th>参数</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="conditionList">
            <!-- Mapping filter -->
            <tr th:if="${tableGroup} == null" th:each="f,s:${mapping?.filter}">
                <td>
                    [[${f?.operation}]]
                </td>
                <td>[[${f?.name}]]</td>
                <td>
                    [[${f?.filter}]]
                </td>
                <td>[[${f?.value}]]</td>
                <td>
                    <i class="fa fa-trash-o text-danger conditionDelete" title="删除"></i>
                </td>
            </tr>
            <!-- TableGroup filter -->
            <tr th:each="f,s:${tableGroup?.filter}">
                <td>
                    [[${f?.operation}]]
                </td>
                <td>[[${f?.name}]]</td>
                <td>
                    [[${f?.filter}]]
                </td>
                <td>[[${f?.value}]]</td>
                <td>
                    <i class="fa fa-trash-o text-danger conditionDelete" title="删除"></i>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- 隐藏表单值 -->
    <div class="hidden">
        <input id="filter" name="filter" class="form-control" type="text"/>
    </div>

<script>
    // 初始化映射关系参数
    function initFilterParams(){
        // 生成JSON参数
        var row = [];
        var $conditionList = $("#conditionList");
        $conditionList.find("tr").each(function(k,v){
            var opt = $(this).find("td:eq(0)").text();
            var sf = $(this).find("td:eq(1)").text();
            var filter = $(this).find("td:eq(2)").text();
            var arg = $(this).find("td:eq(3)").text();
            row.push({
               "name": sf,
               "operation": opt,
               "filter": filter,
               "value": arg
             });
        });
        var $conditionTable = $("#conditionTable");
        if (0 >= row.length) {
            $conditionTable.addClass("hidden");
        } else {
            $conditionTable.removeClass("hidden");
        }
        $("#filter").val(JSON.stringify(row));
    }

    // 绑定新增条件点击事件
    function bindFilterAdd() {
        $("#conditionAdd").unbind("click").bind('click', function () {
            var conditionOperation = $("#conditionOperation").val();
            var conditionSourceField = $("#conditionSourceField").val();
            var conditionFilter = $("#conditionFilter").val();
            var conditionArg = $("#conditionArg").val();
            var $conditionList = $("#conditionList");
            // 自定义SQL
            if (conditionOperation == 'sql') {
                if (isBlank(conditionArg)) {
                    bootGrowl("参数不能空.", "danger");
                    return;
                }
                $conditionList.html('');
                conditionSourceField = '';
                conditionFilter = '';
            }
            // 非空检查
            else if(isBlank(conditionSourceField)){
                bootGrowl("数据源表字段不能空.", "danger");
                return;
            }

            // 检查重复字段
            var repeated = false;
            $conditionList.find("tr").each(function(k,v){
                 var opr = $(this).find("td:eq(0)").text();
                 var sf = $(this).find("td:eq(1)").text();
                 var filter = $(this).find("td:eq(2)").text();
                 var arg = $(this).find("td:eq(3)").text();
                 if(repeated = (opr==conditionOperation && sf==conditionSourceField && filter==conditionFilter && arg==conditionArg)){
                    bootGrowl("过滤条件已存在.", "danger");
                    // break;
                    return false;
                 }
            });
            if(repeated){ return; }

            var trHtml = "<tr>";
            trHtml += "<td>" + conditionOperation + "</td>";
            trHtml += "<td>" + conditionSourceField + "</td>";
            trHtml += "<td>" + conditionFilter + "</td>";
            trHtml += "<td>" + conditionArg + "</td>";
            trHtml += "<td><i class='fa fa-trash-o text-danger conditionDelete' title='删除'></i></td>";
            trHtml += "</tr>";
            $conditionList.append(trHtml);
            // 清空参数
            $("#conditionArg").val("");
            initFilterParams();
        });
    }

    // 绑定表格点击删除事件
    function bindFilterListDelete(){
        $(".conditionDelete").unbind("click").bind('click', function(){
            // 阻止tr触发click事件
            event.cancelBubble=true;
            $(this).parent().parent().remove();
            initFilterParams();
        });
        initFilterParams();
    }

    // 绑定添加定时系统参数
    function bindFilterQuartzFilterAdd(){
        $(".conditionQuartzFilter").unbind("click").bind('click', function () {
            const $tmpVal = $("#conditionArg");
            $tmpVal.val($tmpVal.val() + $(this).text());
        });
    }

    $(document).ready(function() {
        initSelect($('#conditionOperation'));
        initSelect($('#conditionSourceField'));
        initSelect($('#conditionFilter'));
        initSelect($('#systemArg'));

        bindFilterAdd();
        bindFilterListDelete();
        bindFilterQuartzFilterAdd();
    });
</script>
</div>

</html>