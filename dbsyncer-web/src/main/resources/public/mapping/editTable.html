<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<div th:fragment="content">
    <!-- 添加映射表区域 -->
    <div class="grid grid-cols-9 items-center mt-4">
        <!-- 数据源表选择器 -->
        <div class="lg:col-span-4 flex items-center form-item">
            <label class="form-label">数据源表</label>
            <select id="source_table_select" class="form-control">
                <option th:each="t,s:${mapping?.sourceTable}" th:value="${t?.name}" th:data-type="${t?.type}" th:text="${t?.name} + ' ('+${t?.type}+')'"/>
            </select>
        </div>

        <div class="text-info items-center text-center">
            <i class="fa fa-angle-double-right fa-2x"></i>
        </div>

        <!-- 目标源表选择器 -->
        <div class="lg:col-span-4 flex items-center form-item">
            <label class="form-label">目标源表</label>
            <select id="target_table_select" class="form-control">
                <option th:each="t,s:${mapping?.targetTable}" th:value="${t?.name}" th:data-type="${t?.type}" th:text="${t?.name} + ' ('+${t?.type}+')'"/>
            </select>
        </div>
    </div>

    <!-- 标记主键区域 -->
    <div class="grid grid-cols-9 items-center mt-4">
        <!-- 数据源主键 -->
        <div class="lg:col-span-4 flex items-center form-item">
            <label class="form-label">标记主键<i class="fa fa-question-circle" title="数据源表/视图没有主键，自定义一个或多个主键"></i></label>
            <div class="form-control-area">
                <input id="sourceTablePK" class="form-control" type="text" data-role="tagsinput" placeholder="请输入主键"/>
            </div>
        </div>

        <div class="text-info items-center text-center"></div>

        <!-- 目标源主键 -->
        <div class="lg:col-span-4 flex items-center form-item">
            <label class="form-label">标记主键<i class="fa fa-question-circle" title="目标源表/视图没有主键，自定义一个或多个主键"></i></label>
            <div class="form-control-area">
                <input id="targetTablePK" class="form-control" type="text" data-role="tagsinput" placeholder="请输入主键"/>
            </div>
        </div>
    </div>

    <!-- 操作按钮区域 -->
    <div class="flex items-center justify-between mt-4">
        <div class="form-actions">
            <div id="searchTableGroup"></div>
        </div>

        <div class="form-actions">
            <button id="tableGroupAddBtn" type="button" class="btn btn-info">
                <i class="fa fa-plus"></i> 添加
            </button>
            <button id="tableGroupDelBtn" type="button" class="btn btn-outline" disabled="disabled">
                <i class="fa fa-trash"></i> 删除
            </button>
            <button id="refreshTableBtn" type="button" class="btn btn-outline" th:title="刷新数据源和目标源表" onclick="bindTableRefresh()">
                <span class="fa fa-refresh"></span>刷新表
            </button>
        </div>
    </div>

    <!-- 表映射列表 -->
    <table class="table search-table-group-list hidden">
        <thead>
        <tr>
            <th></th>
            <th>
                数据源表
            </th>
            <th>
                目标源表
            </th>
            <th onclick="event.stopPropagation();">
                <input type="checkbox" class="tableGroupCheckboxAll" value="all" onclick="event.stopPropagation();" />
            </th>
        </tr>
        </thead>
        <tbody id="tableGroupList"></tbody>
    </table>
    <input id="sortedTableGroupIds" name="sortedTableGroupIds" type="hidden" />

<script>
    // 刷新驱动编辑页面
    function refreshMappingEditPage(params) {
        let url = '/mapping/page/edit?id=' + $("#mappingId").val();
        if (params) {
            url += params;
        }
        doLoader(url);
    }

    function bindTableSelect(selector, type, onChange){
        return selector.dbSelect({
            type: 'multiple',
            onSelect: function (data) {
                if (onChange) {
                    onChange(data);
                }
            },
            defaultValue: [],// 默认选中
            customButtons: [ // 最多2个自定义按钮
                {
                    text: '取消过滤',
                    callback: function(values) {
                        refreshMappingEditPage('&exclude=1');
                        bootGrowl("取消过滤成功!", "success");
                    }
                },
                {
                    text: '自定义表',
                    callback: function(values) {
                        doLoader('/mapping/pageCustomTable?id=' + $("#mappingId").val() + '&type=' + type);
                    }
                }
            ]
        });
    }

    // 绑定刷新下拉表事件
    function bindTableRefresh() {
        let id = $("#mappingId").val();
        doPoster("/mapping/refreshTables", {'id': id}, function (data) {
            if (data.success === true) {
                bootGrowl("刷新表成功!", "success");
                refreshMappingEditPage();
            } else {
                bootGrowl(data.message, "danger");
            }
        });
    }

    // 绑定添加表映射关系事件
    function bindTableGroupAdd(sourceSelector, targetSelector){
        $("#tableGroupAddBtn").unbind("click").bind('click', function (e) {
            let sTables = sourceSelector.getValues();
            let sLen = sTables.length;
            if (sLen < 1) {
                bootGrowl("请选择数据源表", "danger");
                return;
            }
            let tTables = targetSelector.getValues();
            let tLen = tTables.length;
            if (tLen < 1) {
                bootGrowl("请选择目标源表", "danger");
                return;
            }
            if (sLen !== tLen) {
                bootGrowl("表映射关系数量不一致，请检查源表和目标表关系", "danger");
                return;
            }
            let m = {};
            m.mappingId = $("#mappingId").val();
            m.sourceTable = sTables.join('|');
            m.targetTable = tTables.join('|');
            m.sourceType = sourceSelector.getAttribute('type');
            m.targetType = targetSelector.getAttribute('type');
            m.sourceTablePK = $("#sourceTablePK").val();
            m.targetTablePK = $("#targetTablePK").val();
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.html('<i class="fa fa-spinner fa-spin"></i> 添加中...').prop('disabled', true);
            doPoster("/tableGroup/add", m, function (data) {
                $btn.html(originalText).prop('disabled', false);
                if (data.success === true) {
                    bootGrowl("新增映射关系成功!", "success");
                } else {
                    bootGrowl(data.message, "danger");
                }
                refreshMappingEditPage();
            });
        });
    }

    // 绑定删除表关系点击事件
    function bindTableGroupRemove() {
        $("#tableGroupDelBtn").unbind("click").click(function () {
            const ids = [];
            $(".tableGroupCheckbox").each(function(){
                if($(this).prop('checked')){
                    ids.push($(this).val());
                }
            });
            if (ids.length > 0) {
                let id = $("#mappingId").val();
                const $btn = $(this);
                const originalText = $btn.html();
                $btn.html('<i class="fa fa-spinner fa-spin"></i> 删除中...').prop('disabled', true);
                doPoster("/tableGroup/remove", {"mappingId": id, "ids" : ids.join()}, function (response) {
                    $btn.html(originalText).prop('disabled', false);
                    if (response.success === true) {
                        bootGrowl("删除映射关系成功!", "success");
                        refreshMappingEditPage();
                    } else {
                        bootGrowl(response.message, "danger");
                    }
                });
            }
        });
    }

    // 绑定复选框多选或单选事件
    function bindTableGroupCheckbox() {
        const $checkboxAll = $('.tableGroupCheckboxAll');
        const $delBtn = $('#tableGroupDelBtn');
        let isUpdatingSelectAll = false;

        // 动态获取所有单个复选框（每次调用时重新查找）
        function getCheckboxes() {
            return $('.tableGroupCheckbox');
        }

        // 更新全选复选框状态
        function updateSelectAllState() {
            if (isUpdatingSelectAll) return;
            isUpdatingSelectAll = true;
            const $checkboxes = getCheckboxes();
            const $checkedCheckboxes = $checkboxes.filter(':checked');
            const allChecked = $checkboxes.length > 0 && $checkboxes.length === $checkedCheckboxes.length;
            const checkboxAllApi = $checkboxAll.data('checkboxGroup');
            if (checkboxAllApi) {
                checkboxAllApi.setValue(allChecked);
            } else {
                $checkboxAll.prop('checked', allChecked);
            }
            setTimeout(function() {
                isUpdatingSelectAll = false;
            }, 0);
        }

        // 更新删除按钮状态
        function updateDeleteButtonState() {
            const $checkboxes = getCheckboxes();
            $delBtn.prop('disabled', $checkboxes.filter(':checked').length === 0);
        }

        // 先移除旧的事件绑定（如果存在）
        $checkboxAll.off('change');
        getCheckboxes().off('change');

        // 初始化全选复选框（如果还没有初始化）
        if (!$checkboxAll.data('checkboxGroupInitialized')) {
            $checkboxAll.checkboxGroup({
                theme: 'danger',
                size: 'md',
                onChange: function(values) {
                    // 全选/取消全选时，同步所有单个复选框
                    const isChecked = values.length > 0;
                    getCheckboxes().each(function() {
                        const api = $(this).data('checkboxGroup');
                        if (api) {
                            api.setValue(isChecked);
                        }
                    });
                    updateDeleteButtonState();
                }
            });
        }

        // 初始化所有单个复选框
        getCheckboxes().each(function() {
            const $checkbox = $(this);
            if (!$checkbox.data('checkboxGroupInitialized')) {
                $checkbox.checkboxGroup({
                    theme: 'danger',
                    size: 'md',
                    onChange: function(values) {
                        updateSelectAllState();
                        updateDeleteButtonState();
                    }
                });
            }
        });
    }

    // 绑定表关系点击事件
    function bindMappingTableGroupListClick() {
        const $tableGroupList = $("#tableGroupList");

        // 检查元素是否存在
        if (!$tableGroupList.length) {
            return;
        }

        $tableGroupList.unbind("click");
        $tableGroupList.find("tr").bind('click', function (e) {
            // 如果点击的是复选框或其父元素的td，不执行跳转
            if ($(e.target).is('input[type="checkbox"]') || $(e.target).closest('td').find('input[type="checkbox"]').length > 0) {
                return;
            }
            doLoader('/tableGroup/page/editTableGroup?id=' + $(this).attr("id"));
        });

        // 使用原生 HTML5 拖拽 API 替代 tableDnD
        const $rows = $tableGroupList.find("tr");
        $rows.each(function() {
            const $row = $(this);
            $row.attr('draggable', 'true');

            // 拖拽开始
            $row.on('dragstart', function(e) {
                e.originalEvent.dataTransfer.effectAllowed = 'move';
                e.originalEvent.dataTransfer.setData('text/html', this.innerHTML);
                $(this).addClass('dragging');
            });

            // 拖拽结束
            $row.on('dragend', function(e) {
                $(this).removeClass('dragging');
                $rows.removeClass('drag-over');

                // 更新排序数据
                var newData = [];
                $tableGroupList.find("tr").each(function () {
                    newData.push($(this).attr('id'));
                });
                $("#sortedTableGroupIds").val(newData.join('|'));
            });

            // 拖拽经过
            $row.on('dragover', function(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.originalEvent.dataTransfer.dropEffect = 'move';
                $(this).addClass('drag-over');
                return false;
            });

            // 拖拽离开
            $row.on('dragleave', function(e) {
                $(this).removeClass('drag-over');
            });

            // 放置
            $row.on('drop', function(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }

                var $dragging = $tableGroupList.find('.dragging');
                if ($dragging.length && $dragging[0] !== this) {
                    // 判断插入位置
                    var draggingIndex = $dragging.index();
                    var targetIndex = $(this).index();

                    if (draggingIndex < targetIndex) {
                        $(this).after($dragging);
                    } else {
                        $(this).before($dragging);
                    }
                }

                return false;
            });
        });
    }

    $(document).ready(function() {
        // 绑定下拉选择事件自动匹配相似表事件
        let targetTableSelect = bindTableSelect($('#target_table_select'), 'target');
        let sourceTableSelect = bindTableSelect($('#source_table_select'), 'source' , function(data) {
            targetTableSelect.setValues(data);
        });
        // 绑定多值输入框事件
        initMultipleInputTags();
        // 绑定添加表映射关系事件
        bindTableGroupAdd(sourceTableSelect, targetTableSelect);
        // 渲染搜索输入框和表格
        function renderSearchTable(pagination, mappingId){
            if (pagination.total > 0) {
                $("#searchTableGroup").html(`<div class="search-wrapper">
                    <i class="fa fa-search search-icon"></i>
                    <input class="search-input" type="text" maxlength="32" placeholder="搜索表名称">
                    <span class="search-clear" title="清除">
                        <i class="fa fa-times"></i>
                    </span>
                </div>`);
                initSearch('searchTableGroup', function (searchKey) {
                    pagination.doSearch({'searchKey': searchKey, 'mappingId': mappingId});
                });
            }
            $(".search-table-group-list").toggleClass("hidden", pagination.total <= 0);
        }

        // 初始化分页管理器
        let initCompleted = false;
        let mappingId = $("#mappingId").val();
        let pagination = new PaginationManager({
            requestUrl: '/tableGroup/search',
            params: {'mappingId': mappingId},
            tableBodySelector: '#tableGroupList',
            pageSize: 5,
            renderRow: function(t, index) {
                return `<tr id="${t.id}" title='点击编辑 | 拖动排序'>
                    <td>${index}</td>
                    <td>${t.sourceTable.name}</td>
                    <td>${t.targetTable.name}</td>
                    <td>
                        <input value="${t.id}" type="checkbox" class="tableGroupCheckbox" />
                    </td>
                </tr>`;
            },
            emptyHtml:'<td colspan="4" class="text-center"><p class="empty-text">暂无映射关系</p></td>',
            refreshCompleted: function() {
                if (!initCompleted) {
                    renderSearchTable(pagination, mappingId);
                    initCompleted = true;
                }
                // 绑定表关系点击事件
                bindMappingTableGroupListClick();
                // 绑定删除表映射关系事件
                bindTableGroupRemove();
                // 绑定复选框多选或单选事件
                bindTableGroupCheckbox();
            }
        });
    });
</script>
</div>

</html>