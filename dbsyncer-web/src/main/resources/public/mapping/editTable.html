<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<div th:fragment="content">
    <!-- 添加映射表区域 -->
    <div class="grid grid-cols-9 items-center mt-4">
        <!-- 数据源表选择器 -->
        <div class="lg:col-span-4 flex items-center gap-3 form-item">
            <label class="form-label">数据源表</label>
            <select id="source_table_select" class="form-control">
                <option th:each="t,s:${mapping?.sourceTable}" th:value="${t?.name}" th:text="${t?.name} + ' ('+${t?.type}+')'"/>
            </select>
        </div>

        <div class="text-info items-center text-center">
            <i class="fa fa-arrow-right"></i>
        </div>

        <!-- 目标源表选择器 -->
        <div class="lg:col-span-4 flex items-center gap-3 form-item">
            <label class="form-label">目标源表</label>
            <select id="target_table_select" class="form-control">
                <option th:each="t,s:${mapping?.targetTable}" th:value="${t?.name}" th:text="${t?.name} + ' ('+${t?.type}+')'"/>
            </select>
        </div>
    </div>

    <!-- 标记主键区域 -->
    <div class="grid grid-cols-9 items-center mt-4">
        <!-- 数据源主键 -->
        <div class="lg:col-span-4 flex items-center gap-3 form-item">
            <label class="form-label">标记主键<i class="fa fa-question-circle" title="数据源表/视图没有主键，自定义一个或多个主键"></i></label>
            <div class="form-control-area">
                <input id="sourceTablePK" class="form-control" type="text" data-role="tagsinput" placeholder="输入主键字段(大小写敏感)"/>
            </div>
        </div>

        <div class="text-info items-center text-center">
            <i class="fa fa-arrow-right"></i>
        </div>

        <!-- 目标源主键 -->
        <div class="lg:col-span-4 flex items-center gap-3 form-item">
            <label class="form-label">标记主键<i class="fa fa-question-circle" title="目标源表/视图没有主键，自定义一个或多个主键"></i></label>
            <div class="form-control-area">
                <input id="targetTablePK" class="form-control" type="text" data-role="tagsinput" placeholder="输入主键字段(大小写敏感)"/>
            </div>
        </div>
    </div>

    <!-- 操作按钮区域 -->
    <div class="flex items-center justify-between mt-4">
        <button id="refreshTableBtn" class="btn btn-outline" th:title="刷新数据源和目标源表" th:tableGroupId="${mapping?.id}">
            <i class="fa fa-refresh"></i> 刷新表
        </button>
        <div class="form-actions">
            <button id="tableGroupAddBtn" th:mappingId="${mapping?.id}" class="btn btn-info">
                <i class="fa fa-plus"></i> 添加
            </button>
            <button id="tableGroupDelBtn" th:mappingId="${mapping?.id}" class="btn btn-outline" disabled="disabled">
                <i class="fa fa-trash"></i> 删除
            </button>
        </div>
    </div>

    <!-- 表映射列表 -->
    <table class="table">
        <thead>
        <tr>
            <th></th>
            <th>
                数据源表
            </th>
            <th>
                目标源表
            </th>
            <th>
                拖动
            </th>
            <th onclick="event.stopPropagation();">
                <input type="checkbox" class="tableGroupCheckboxAll" value="all" onclick="event.stopPropagation();" />
            </th>
        </tr>
        </thead>
        <tbody id="tableGroupList">
        <tr th:id="${t?.id}" title='拖动排序 | 点击编辑' th:each="t,state : ${tableGroups}">
            <td th:text="1"/>
            <td th:text="${t?.sourceTable.name}"/>
            <td th:text="${t?.targetTable.name}"/>
            <td>
                <i class="fa fa-arrows text-tertiary" style="cursor: move;"></i>
            </td>
            <td onclick="event.stopPropagation();">
                <input th:value="${t?.id}" th:mappingId="${mapping?.id}" type="checkbox" class="tableGroupCheckbox" onclick="event.stopPropagation();" />
            </td>
        </tr>
        <tr title='拖动排序 | 点击编辑'>
            <td th:text="1"/>
            <td th:text="my_user"/>
            <td th:text="my_user"/>
            <td>
                <i class="fa fa-arrows text-tertiary" style="cursor: move;"></i>
            </td>
            <td onclick="event.stopPropagation();">
                <input th:value="${t?.id}" type="checkbox" class="tableGroupCheckbox" onclick="event.stopPropagation();" />
            </td>
        </tr>
        <tr title='拖动排序 | 点击编辑'>
            <td th:text="2"/>
            <td th:text="my_user2"/>
            <td th:text="my_user2"/>
            <td>
                <i class="fa fa-arrows text-tertiary" style="cursor: move;"></i>
            </td>
            <td onclick="event.stopPropagation();">
                <input th:value="${t?.id}" type="checkbox" class="tableGroupCheckbox" onclick="event.stopPropagation();" />
            </td>
        </tr>
        </tbody>
    </table>
    <input id="sortedTableGroupIds" name="sortedTableGroupIds" type="hidden" />

    <script>
        function bindTableSelect(selector, onChange){
            return selector.dbSelect({
                type: 'multiple',
                onSelect: function (data) {
                    if (onChange) {
                        onChange(data);
                    }
                },
                defaultValue: [],// 默认选中
                customButtons: [ // 最多2个自定义按钮
                    {
                        text: '取消过滤',
                        callback: function(values) {
                            console.log('取消过滤:', values);
                        }
                    },
                    {
                        text: '过滤',
                        callback: function(values) {
                            console.log('过滤:', values);
                        }
                    }
                ],
                onCustomButton: function(index, values, text) {  // 自定义按钮点击
                    console.log('按钮索引:', index, '选中值:', values, '按钮文本:', text);
                }
            });
        }

        // 绑定下拉选择事件自动匹配相似表事件
        $(document).ready(function() {
            let targetTableSelect = bindTableSelect($('#target_table_select'));
            let sourceTableSelect = bindTableSelect($('#source_table_select'), function(data) {
                console.log(data);
                targetTableSelect.setValues([data]);
            });

            let isUpdatingSelectAll = false;
            
            // 初始化全选复选框
            $('.tableGroupCheckboxAll').checkboxGroup({
                theme: 'danger',
                size: 'md',
                onChange: function(values) {
                    if (isUpdatingSelectAll) return;
                    
                    // 全选/取消全选时，同步所有单个复选框
                    const isChecked = values.length > 0;
                    $('.tableGroupCheckbox').each(function() {
                        const api = $(this).data('checkboxGroup');
                        if (api) {
                            api.setValue(isChecked);
                        }
                    });
                    
                    // 更新删除按钮状态
                    updateDeleteButtonState();
                }
            });
            
            // 初始化所有单个复选框
            $('.tableGroupCheckbox').checkboxGroup({
                theme: 'info',
                size: 'md',
                onChange: function(values) {
                    // 单个复选框变化时，更新全选复选框状态
                    updateSelectAllState();
                    // 更新删除按钮状态
                    updateDeleteButtonState();
                }
            });
            
            // 更新全选复选框状态
            function updateSelectAllState() {
                if (isUpdatingSelectAll) return;
                
                isUpdatingSelectAll = true;
                
                const $allCheckboxes = $('.tableGroupCheckbox');
                const $checkedCheckboxes = $('.tableGroupCheckbox:checked');
                const allChecked = $allCheckboxes.length > 0 && $allCheckboxes.length === $checkedCheckboxes.length;
                
                const $checkboxAll = $('.tableGroupCheckboxAll');
                const checkboxAllApi = $checkboxAll.data('checkboxGroup');
                
                if (checkboxAllApi) {
                    checkboxAllApi.setValue(allChecked);
                } else {
                    $checkboxAll.prop('checked', allChecked);
                }
                
                setTimeout(function() {
                    isUpdatingSelectAll = false;
                }, 0);
            }
            
            // 更新删除按钮状态
            function updateDeleteButtonState() {
                const $checkedCheckboxes = $('.tableGroupCheckbox:checked');
                $('#tableGroupDelBtn').prop('disabled', $checkedCheckboxes.length === 0);
            }
            
            // 初始化删除按钮状态
            updateDeleteButtonState();
        });
    </script>
</div>

</html>