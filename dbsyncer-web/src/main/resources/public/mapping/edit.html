<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <link type="text/css" rel="stylesheet" th:href="@{/css/mapping/edit.css}">
</head>

<div class="container-fluid">
    <div class="container">
        <form id="mappingModifyForm" class="form-horizontal" role="form" method="post">
            <!-- 标题 -->
            <div class="row text-center">
                <div class="text-right"  style="position: relative; width: 100%;" >
                    <button id="mappingBackBtn" type="button" class="btn btn-default">
                        <span class="fa fa-reply"></span>返回
                    </button>
                    <button id="mappingSubmitBtn" th:onclick="doMappingSubmit()"  th:attr="disabled=${mapping?.meta?.state eq 1}" type="button" class="btn btn-primary">
                        <span class="fa fa-save"></span>保存
                    </button>
                </div>
                <h3>
                    <span id="mappingModifyName">[[${mapping?.name}]]</span>&nbsp;
                    <i th:onclick="mappingModifyName()" th:title="点击修改名称" class="fa fa-edit well-sign-green dbsyncer_pointer"></i>
                    
                    <span class="mapping-operation-buttons" style="margin-left: 20px;">
                        <a th:attr="data-url='/mapping/copy?id='+${mapping?.id}"
                           href="javascript:;"
                           class="btn btn-info margin-right-5"
                           title="复制任务">
                            <i class="fa fa-copy"></i> 复制
                        </a>
                        <a th:if="${mapping?.meta?.state ne 1}"
                           th:attr="data-url='/mapping/remove?id='+${mapping?.id}"
                           href="javascript:;"
                           confirm="true"
                           confirmMessage="确认删除任务?"
                           class="btn btn-danger margin-right-5"
                           title="删除任务">
                            <i class="fa fa-trash"></i> 删除
                        </a>
                        <a th:attr="data-url='/mapping/reset?id='+${mapping?.id}"
                           href="javascript:;"
                           confirm="true"
                           confirmMessage="确认重置任务?"
                           class="btn btn-default margin-right-5"
                           title="重置任务">
                            <i class="fa fa-refresh"></i> 重置
                        </a>
                                                <a th:if="${mapping?.meta?.fail gt 0}"
                           th:attr="id=${mapping?.id}"
                           href="javascript:;"
                           class="btn btn-default margin-right-5 queryData"
                           title="查看日志">
                            <i class="fa fa-file-text-o"></i> 日志
                        </a>
                    </span>
                </h3>
                <p>[[${mapping?.id}]]</p>
            </div>

            <!-- 隐藏表单值 -->
            <div class="form-group hidden">
                <input id="mappingId" name="id" type="text" th:value="${mapping?.id}"/>
                <input id="metaModelHidden"  type="hidden" th:value="${mapping?.meta?.total}"/>
                <input id="successHidden"  type="hidden" th:value="${mapping?.meta?.success}"/>
                <input id="failHidden" type="hidden" th:value="${mapping?.meta?.fail}"/>
                <input name="name" type="text" th:value="${mapping?.name}"/>
                <input name="state" type="text" th:value="${mapping?.meta?.state}"/>
                <input name="model" type="hidden" th:value="${mapping?.model}"/>
                <input type="hidden" id="mappingShow" th:value="${classOn}" />
            </div>

            <!-- 任务信息面板 -->
            <div class="row">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="row">
                                    <div class="col-md-4 text-right">
                                        <img draggable="false" class="dbsyncer_img" th:src="@{'/img/'+ ${mapping?.sourceConnector?.config?.connectorType} + '.png'}">
                                    </div>
                                    <div class="col-md-8">
                                        <p class="driver_break_word">[[${mapping?.sourceConnector?.name}]]</p>
                                        <p>数据源：[[${mapping?.sourceConnector?.config?.connectorType}]]</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4 text-center">
                                <div class="row-fluid">
                                    <div class="span4"><span class="fa fa-arrow-right fa-3x"></span></div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="row">
                                    <div class="col-md-4 text-right">
                                        <img draggable="false" class="dbsyncer_img" th:src="@{'/img/'+ ${mapping?.targetConnector?.config?.connectorType} + '.png'}">
                                    </div>
                                    <div class="col-md-8">
                                        <p class="driver_break_word">[[${mapping?.targetConnector?.name}]]</p>
                                        <p>目标源：[[${mapping?.targetConnector?.config?.connectorType}]]</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-body" th:with="model=${mapping?.model},total=${mapping?.meta?.total},success=${mapping?.meta?.success},fail=${mapping?.meta?.fail},beginTime=${mapping?.meta?.beginTime},updateTime=${mapping?.meta?.updateTime}">
                        <div class="row">
                            <div class="col-md-2">
                                <div  class="text-left" id ="mappingState">
                                    <p>任务状态：</p>
                                    <span th:if="${mapping?.meta?.state eq 0}" class="highlight-number total-color">未运行</span>
                                    <span th:if="${mapping?.meta?.state eq 1}" class="highlight-number success-color">运行中</span>
                                    <span th:if="${mapping?.meta?.state eq 2}" class="highlight-number error-color">停止中</span>
                                    <span th:if="${mapping?.meta?.state eq 3}" class="highlight-number error-color">异常</span>
                                </div>
                            </div>
                            <div class="col-md-2" id="metaPercent">
                                <div class="text-left">
                                    <p>数据同步进度:</p>
                                    <span th:if="${mapping?.meta?.counting}">(正在统计中)</span>
                                    <span th:unless="${mapping?.meta?.counting}">
                                            <span th:if="${total gt 0 and (success + fail) gt 0}" class="highlight-number">
                                                [[${#numbers.formatPercent(((success + fail) / total), 1, 2)}]]
                                            </span>
                                            <span th:unless="${total gt 0 and (success + fail) gt 0}" class="highlight-number" >0%</span>
                                        </span>
                                    <!--环状图-->
<!--                                    <canvas id="progressChart" width="100" height="100" style="display: block; margin: 0 auto;"></canvas>-->
                                    <!--   <p id="progressText" style="font-size: 1.2em; font-weight: bold; color: #333;">0%</p>-->
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div  class="text-left" id ="metaDuration" style="white-space: nowrap; padding-right: 10px;">
                                    <p>耗时:</p>
                                    <span th:if="${beginTime gt 0 and updateTime gt 0}">
                                        <span th:with="seconds=${(updateTime - beginTime) / 1000}">
                                            <span th:if="${seconds lt 60}" th:text="${seconds + '秒'}" class="highlight-number"/>
                                            <span th:if="${seconds ge 60 and seconds lt 3600}" th:with="minutes=${seconds / 60}" th:text="${minutes + '分' + (seconds - minutes * 60) + '秒'}" class="highlight-number"/>
                                            <span th:if="${seconds ge 3600}" th:with="hours=${seconds / 3600}, minutes=${(seconds - hours * 3600) / 60}" th:text="${hours + '时' + minutes + '分' + (seconds - hours * 3600 - minutes * 60) + '秒'}" class="highlight-number"/>
                                        </span>
                                    </span>
                                    <span th:unless="${beginTime gt 0 and updateTime gt 0}" class="highlight-number">-</span>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div  class="text-left" id ="metaModel">
<!--                                    <p>[[${mapping?.meta?.model}]]同步</p>-->
                                    <p>总数:</p>
                                    <span class="highlight-number total-color">[[${total}]]</span>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div id="metaSuccess">
                                    <p>成功:</p>
                                    <span class="highlight-number success-color">[[${success}]]</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-left" id="metaError">
                                    <p>失败:</p>
                                    <span class="highlight-number error-color">[[${fail}]]</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab菜单 -->
            <div class="row">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation"  class="active">
                        <a href="#mappingBaseConfig" aria-controls="mappingBaseConfig" role="tab" data-toggle="tab">
                            映射关系
                            <small class="text-muted" title="该配置使所有映射关系都生效">（全局）</small>
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#mappingSuperConfig" aria-controls="mappingSuperConfig" role="tab" data-toggle="tab">
                            高级配置
                            <small class="text-muted" title="该配置使所有映射关系都生效">（全局）</small>
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#mappingSummary" aria-controls="mappingSummary" role="tab" data-toggle="tab">
                            概括
                        </a>
                    </li>
                </ul>

                <!-- Tab内容区域 -->
                <div class="tab-content" style="margin-top: 15px;">

                    <!-- 映射关系Tab面板 -->
                    <div role="tabpanel" class="tab-pane active" id="mappingBaseConfig">
                        <!-- 表映射 -->
                        <div th:replace="mapping/editTable :: content"></div>
                        <!-- 下一步按钮 -->
                        <div class="row text-right">
                            <button type="button"  th:onclick="nextToMapping('mappingSuperConfig')" class="btn btn-primary">
                                <span class="fa fa-arrow-right"></span> 下一步
                            </button>
                        </div>
                    </div>

                    <!-- 高级配置Tab面板 -->
                    <div role="tabpanel" class="tab-pane" id="mappingSuperConfig">
                        <!-- 通用配置 -->
                        <div th:replace="mapping/editCommon :: content"></div>

                        <!-- 全量配置 -->
                        <div th:id="mappingFullConfig" class="hidden" th:fragment="content">
                            <div th:replace="mapping/editFull :: content"></div>
                        </div>

                        <!-- 增量配置 -->
                        <div th:id="mappingIncrementConfig" class="hidden" th:fragment="content">
                            <div th:replace="mapping/editIncrement :: content"></div>
                        </div>

                        <!-- 过滤条件 -->
                        <div th:replace="mapping/editFilter :: content"></div>

                        <!-- 转换配置 -->
                        <div th:replace="mapping/editConvert :: content"></div>

                        <!-- 策略配置 -->
                        <div th:replace="mapping/editParameter :: content"></div>

                        <!-- 插件配置 -->
                        <div th:replace="mapping/editPlugin :: content"></div>
                        <div class="row text-right">
                            <button type="button"  th:onclick="nextToMapping('mappingBaseConfig')" class="btn btn-default">
                                <span class="fa fa-arrow-left"></span> 上一步
                            </button>
                            <button type="button"  th:onclick="nextToMapping('mappingSummary')" class="btn btn-primary">
                                <span class="fa fa-arrow-right"></span> 下一步
                            </button>
                        </div>
                    </div>

                    <!-- 概括Tab面板 -->
                    <div role="tabpanel" class="tab-pane" id="mappingSummary">
                        <!-- 表同步进度列表 -->
                        <div class="row" style="margin-top: 20px;">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <h5 style="margin-bottom: 15px;">表同步进度</h5>
                                    <table id="tableGroupProgress" class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>数据源表</th>
                                                <th>目标源表</th>
                                                <th>同步数量</th>
                                                <th>全量同步进度</th>
                                                <th>同步速度</th>
                                                <th>状态</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 动态填充表数据 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="row text-right">
                            <button type="button"  th:onclick="nextToMapping('mappingSuperConfig')" class="btn btn-default">
                                <span class="fa fa-arrow-left"></span> 上一步
                            </button>
                            <button type="button" th:attr="disabled=${mapping?.meta?.state eq 1}" th:onclick="doMappingSubmit()" class="btn btn-primary">
                                <span class="fa fa-save"></span>保存
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>
</div>

<script th:src="@{/js/mapping/chart.js}"></script>
<script th:src="@{/js/mapping/edit.js}"></script>
<script th:src="@{/js/mapping/editFilterAndConvert.js}"></script>
<script th:src="@{/js/mapping/editIncrement.js}"></script>
<script th:src="@{/js/mapping/editPlugin.js}"></script>
