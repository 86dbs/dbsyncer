<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<div class="form-container">
    <div class="card-header">
        <h3 class="card-title text-center">添加任务</h3>
    </div>

    <div class="card-body">
        <div class="form-actions mb-4">
            <button id="taskSubmitBtn" type="button" class="btn btn-primary">
                <i class="fa fa-save"></i>
                保存
            </button>
            <button id="taskBackBtn" type="button" class="btn btn-outline">
                <i class="fa fa-reply"></i>
                返回
            </button>
        </div>

        <!-- 步骤指示器 -->
        <div class="dbsyncer-steps" style="display: flex; justify-content: center; align-items: center; max-width: 600px; margin: 0 auto;">
            <div class="step-item active" id="step1Indicator" style="flex: 1; display: flex; align-items: center;">
                <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 16px;">
                    1
                </div>
                <div class="step-label" style="margin-left: 12px; flex: 1;">
                    <div style="font-weight: 500; color: var(--text-primary);">基础配置</div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">任务基本信息</div>
                </div>
            </div>
            <div class="step-line" style="width: 80px; height: 2px; background: #e5e7eb; margin: 0 16px;"></div>
            <div class="step-item" id="step2Indicator" style="flex: 1; display: flex; align-items: center;">
                <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 16px;">
                    2
                </div>
                <div class="step-label" style="margin-left: 12px; flex: 1;">
                    <div style="font-weight: 500; color: var(--text-secondary);">表映射配置</div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">配置表和字段映射</div>
                </div>
            </div>
        </div>

        <!-- 表单主体 -->
        <form id="taskAddForm">

            <!-- 第一步：基础配置 -->
            <div id="step1Content" class="step-content">

                <!-- 任务基本配置 -->
                <div class="dbsyncer-card" style="margin-bottom: 24px;">
                    <div class="dbsyncer-card-header" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                        <h3 class="dbsyncer-card-title">
                            <i class="fa fa-info-circle" style="color: var(--primary-color); margin-right: 8px;"></i>
                            任务基本配置
                        </h3>
                    </div>
                    <div class="dbsyncer-card-body">
                        <!-- 任务名称 -->
                        <div class="form-group" style="margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 16px;">
                                <label class="form-label">
                                    <i class="fa fa-tag" style="color: var(--primary-color); margin-right: 4px;"></i>
                                    任务名称<strong class="text-primary">*</strong>
                                </label>
                                <div class="form-control-area">
                                    <input class="form-control" name="name" type="text" maxlength="200"
                                           required placeholder="请输入任务名称" />
                                </div>
                            </div>
                        </div>

                        <!-- 任务类型（隐藏字段，使用默认值） -->
                        <input type="hidden" name="type" value="SYNC" />
                    </div>
                </div>



                <!-- 数据库配置 -->
                <div class="dbsyncer-card" style="margin-bottom: 24px;">
                    <div class="dbsyncer-card-header" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                        <h3 class="dbsyncer-card-title">
                            <i class="fa fa-database" style="color: var(--success-color); margin-right: 8px;"></i>
                            数据库配置
                        </h3>
                    </div>
                    <div class="dbsyncer-card-body">
                        <!-- 源连接器 和 源数据库名称 -->
                        <div class="form-group" style="margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: 120px 1fr 120px 1fr; align-items: center; gap: 16px;">
                                <label class="form-label">
                                    <i class="fa fa-plug" style="color: var(--primary-color); margin-right: 4px;"></i>
                                    源连接器<strong class="text-primary">*</strong>
                                </label>
                                <div class="form-control-area">
                                    <select name="sourceConnectorId" id="sourceConnectorId" class="form-control select-control" required>
                                        <option value="">请选择源连接器</option>
                                        <option th:each="c,s:${connectors}" th:value="${c?.id}"
                                                th:text="${c?.name + ' (' + c?.config?.connectorType + ')'}" />
                                    </select>
                                </div>
                                <label class="form-label">
                                    <i class="fa fa-database" style="color: var(--primary-color); margin-right: 4px;"></i>
                                    源数据库<strong class="text-primary">*</strong>
                                </label>
                                <div class="form-control-area">
                                    <select name="sourceDatabaseName" id="sourceDatabaseName" class="form-control select-control" required>
                                        <option value="">请先选择源连接器</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 目标连接器 和 目标数据库名称 -->
                        <div class="form-group" style="margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: 120px 1fr 120px 1fr; align-items: center; gap: 16px;">
                                <label class="form-label">
                                    <i class="fa fa-plug" style="color: var(--success-color); margin-right: 4px;"></i>
                                    目标连接器<strong class="text-primary">*</strong>
                                </label>
                                <div class="form-control-area">
                                    <select name="targetConnectorId" id="targetConnectorId" class="form-control select-control" required>
                                        <option value="">请选择目标连接器</option>
                                        <option th:each="c,s:${connectors}" th:value="${c?.id}"
                                                th:text="${c?.name + ' (' + c?.config?.connectorType + ')'}" />
                                    </select>
                                </div>
                                <label class="form-label">
                                    <i class="fa fa-database" style="color: var(--success-color); margin-right: 4px;"></i>
                                    目标数据库<strong class="text-primary">*</strong>
                                </label>
                                <div class="form-control-area">
                                    <select name="targetDatabaseName" id="targetDatabaseName" class="form-control select-control" required>
                                        <option value="">请先选择目标连接器</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Schema 配置 (条件显示) -->
                        <div class="form-group" id="sourceSchemaGroup" style="display: none;">
                            <div style="display: grid; grid-template-columns: 120px 1fr 120px 1fr; align-items: center; gap: 16px;">
                                <label class="form-label">
                                    <i class="fa fa-sitemap" style="color: var(--primary-color); margin-right: 4px;"></i>
                                    源Schema
                                </label>
                                <div class="form-control-area">
                                    <input class="form-control" name="sourceSchema" id="sourceSchema" type="text"
                                           placeholder="请输入源Schema" />
                                </div>
                                <label class="form-label">
                                    <i class="fa fa-sitemap" style="color: var(--success-color); margin-right: 4px;"></i>
                                    目标Schema
                                </label>
                                <div class="form-control-area">
                                    <input class="form-control" name="targetSchema" id="targetSchema" type="text"
                                           placeholder="请输入目标Schema" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 同步触发规则 -->
                <div class="dbsyncer-card" style="margin-bottom: 24px;">
                    <div class="dbsyncer-card-header" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                        <h3 class="dbsyncer-card-title">
                            <i class="fa fa-clock-o" style="color: var(--warning-color); margin-right: 8px;"></i>
                            同步触发规则
                        </h3>
                    </div>
                    <div class="dbsyncer-card-body">
                        <!-- 触发方式 -->
                        <div class="form-group" style="margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 16px;">
                                <label class="form-label">
                                    <i class="fa fa-cogs" style="color: var(--warning-color); margin-right: 4px;"></i>
                                    触发方式<strong class="text-primary">*</strong>
                                </label>
                                <div class="form-control-area">
                                    <label class="radio-inline" style="margin-right: 24px;">
                                        <input type="radio" name="trigger" value="once" checked
                                               style="margin-right: 6px; width: 16px; height: 16px; vertical-align: middle;">
                                        <span style="vertical-align: middle;">执行一次</span>
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="trigger" value="timing"
                                               style="margin-right: 6px; width: 16px; height: 16px; vertical-align: middle;">
                                        <span style="vertical-align: middle;">定时触发</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Cron 表达式 (条件显示) -->
                        <div class="form-group" id="cronGroup" style="display: none;">
                            <div style="display: grid; grid-template-columns: 120px 1fr 100px; align-items: center; gap: 16px;">
                                <label class="form-label">
                                    <i class="fa fa-calendar" style="color: var(--warning-color); margin-right: 4px;"></i>
                                    Cron表达式<strong class="text-primary">*</strong>
                                </label>
                                <div class="form-control-area">
                                    <input class="form-control" name="cron" type="text" value="0 0 1 * * ?"
                                           placeholder="请输入Cron表达式，例如：0 0 1 * * ?" />
                                </div>
                                <div>
                                    <button type="button" class="dbsyncer-btn dbsyncer-btn-secondary"
                                            onclick="showCronHelp()" style="width: 100%;">
                                        <i class="fa fa-question-circle dbsyncer-btn-icon-left"></i>
                                        帮助
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 同步范围与策略 -->
                <div class="dbsyncer-card" style="margin-bottom: 24px;">
                    <div class="dbsyncer-card-header" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
                        <h3 class="dbsyncer-card-title">
                            <i class="fa fa-sliders" style="color: var(--danger-color); margin-right: 8px;"></i>
                            同步范围与策略
                        </h3>
                    </div>
                    <div class="dbsyncer-card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- 左列 -->
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="autoMatchTable" value="true"
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-magic" style="color: var(--primary-color); margin-right: 6px;"></i>
                                    <span>自动匹配表</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="verification" value="true" checked
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-check-circle" style="color: var(--success-color); margin-right: 6px;"></i>
                                    <span>数据校验</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="correction" value="true"
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-wrench" style="color: var(--warning-color); margin-right: 6px;"></i>
                                    <span>数据修正</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="tableStructure" value="true" checked
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-table" style="color: var(--primary-color); margin-right: 6px;"></i>
                                    <span>表结构同步</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="rowData" value="true" checked
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-list" style="color: var(--success-color); margin-right: 6px;"></i>
                                    <span>行数据同步</span>
                                </label>
                            </div>

                            <!-- 右列 -->
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="index" value="true"
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-bookmark" style="color: var(--primary-color); margin-right: 6px;"></i>
                                    <span>索引同步</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="triggerFlag" value="true"
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-bolt" style="color: var(--warning-color); margin-right: 6px;"></i>
                                    <span>触发器同步</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="function" value="true"
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-code" style="color: var(--success-color); margin-right: 6px;"></i>
                                    <span>函数同步</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="storedProcedure" value="true"
                                           style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                                    <i class="fa fa-file-code-o" style="color: var(--danger-color); margin-right: 6px;"></i>
                                    <span>存储过程同步</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第一步操作按钮 -->
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding: 20px 0; border-top: 1px solid #e5e7eb;">
                    <button type="button" class="dbsyncer-btn dbsyncer-btn-secondary" id="step1BackBtn">
                        <i class="fa fa-reply dbsyncer-btn-icon-left"></i>
                        返回
                    </button>
                    <button type="button" class="dbsyncer-btn dbsyncer-btn-primary" id="step1NextBtn">
                        <span>下一步</span>
                        <i class="fa fa-arrow-right" style="margin-left: 8px;"></i>
                    </button>
                </div>

            </div>
            <!-- 第一步结束 -->

            <!-- 第二步：表映射配置 -->
            <div id="step2Content" class="step-content hidden">

                <!-- 表映射配置 -->
                <div class="dbsyncer-card" style="margin-bottom: 24px;">
                    <div class="dbsyncer-card-header" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);">
                        <h3 class="dbsyncer-card-title">
                            <i class="fa fa-exchange" style="color: var(--primary-color); margin-right: 8px;"></i>
                            表映射配置
                        </h3>


                    </div>
                    <div class="dbsyncer-card-body" style="padding: 24px;">
                        <!-- 操作按钮区域 -->
                        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 24px;">
                            <button type="button" class="dbsyncer-btn dbsyncer-btn-secondary" id="removeTableMappingBtn">
                                <i class="fa fa-trash dbsyncer-btn-icon-left"></i>
                                删除选中
                                            </button>
                            <button type="button" class="dbsyncer-btn dbsyncer-btn-primary" id="addTableMappingBtn">
                                                <i class="fa fa-plus dbsyncer-btn-icon-left"></i>
                                添加表映射
                                            </button>
                                        </div>

                        <!-- 表映射列表 -->
                        <div class="dbsyncer-table-wrapper">
                            <table class="dbsyncer-table" id="tableMappingTable">
                                                <thead>
                                                <tr>
                                        <th style="width: 5%; text-align: center;">
                                            <input type="checkbox" id="selectAllMappings" style="width: 16px; height: 16px; cursor: pointer;" />
                                        </th>
                                        <th style="width: 8%;">序号</th>
                                        <th style="width: 38%;">
                                            <i class="fa fa-database" style="color: var(--primary-color); margin-right: 4px;"></i>
                                            源表
                                        </th>
                                        <th style="width: 38%;">
                                            <i class="fa fa-database" style="color: var(--success-color); margin-right: 4px;"></i>
                                            目标表
                                        </th>
                                        <th style="width: 11%; text-align: center;">操作</th>
                                                </tr>
                                                </thead>
                                <tbody id="tableMappingsContainer">
                                    <!-- 表映射行将动态添加到这里 -->
                                                </tbody>
                                            </table>
                                    </div>
                        
                        <!-- 空状态提示 -->
                        <div id="emptyTableMappingTip" style="text-align: center; padding: 40px 0; color: var(--text-tertiary); display: none;">
                            <i class="fa fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <p style="font-size: 14px;">暂无表映射配置，请点击"添加表映射"按钮添加</p>
                        </div>
                    </div>
                </div>

                <!-- 第二步操作按钮 -->
                <div style="display: flex; justify-content: space-between; gap: 12px; margin-top: 24px; padding: 20px 0; border-top: 1px solid #e5e7eb;">
                    <button type="button" class="dbsyncer-btn dbsyncer-btn-secondary" id="step2PrevBtn">
                        <i class="fa fa-arrow-left dbsyncer-btn-icon-left"></i>
                        上一步
                    </button>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="dbsyncer-btn dbsyncer-btn-secondary" id="step2BackBtn">
                            <i class="fa fa-reply dbsyncer-btn-icon-left"></i>
                            返回列表
                        </button>
                        <button type="button" class="dbsyncer-btn dbsyncer-btn-primary" id="step2SubmitBtn">
                            <i class="fa fa-check dbsyncer-btn-icon-left"></i>
                            完成
                        </button>
                    </div>
                </div>

            </div>
            <!-- 第二步结束 -->

        </form>
    </div>
</div>

<script type="text/javascript">
    // 全局变量
    let currentStep = 1; // 当前步骤
    let savedTaskId = null; // 保存的任务ID
    let tableMappingIndex = 0; // 下一个表映射的索引
    let step1Data = null; // 第一步的数据（暂存，不提交）

    // 初始化
    $(document).ready(function () {
        console.log('[任务添加] 页面初始化');
        console.log('[任务添加] step1Content 是否存在:', $('#step1Content').length > 0);
        console.log('[任务添加] step2Content 是否存在:', $('#step2Content').length > 0);
        
        // 初始化所有 select 元素（如果 enhanceAllSelects 函数存在）
        if (typeof enhanceAllSelects === 'function') {
            console.log('[任务添加] 初始化 select 元素增强');
            enhanceAllSelects();
        }
        
        // 阻止表单默认提交行为
        $('#taskAddForm').on('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('[表单] 阻止了表单提交');
            return false;
        });
        
        // 绑定步骤切换按钮事件
        $('#step1BackBtn').click(function () {
            backTaskIndexPage();
        });
        
        $('#step1NextBtn').click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            saveStep1AndGoNext();
            return false;
        });
        
        $('#step2PrevBtn').click(function () {
            console.log('[第二步] 返回第一步');
            // 返回第一步时不清空数据，允许用户修改
            goToStep(1);
        });
        
        $('#step2BackBtn').click(function () {
            backTaskIndexPage();
        });
        
        $('#step2SubmitBtn').click(function () {
            saveStep2AndComplete();
        });
        
        // 隐藏顶部工具栏的保存和返回按钮（使用步骤按钮代替）
        $('#taskSubmitBtn, #taskBackBtn').hide();

        // 触发方式变化事件
        $('input[name="trigger"]').change(function () {
            if ($(this).val() === 'timing') {
                $('#cronGroup').show();
            } else {
                $('#cronGroup').hide();
            }
        });

        // 源连接器变化事件
        $('#sourceConnectorId').change(function () {
            const connectorId = $(this).val();
            if (connectorId) {
                loadDatabases(connectorId, 'source');
                checkAndShowSchema(connectorId, 'source');
            } else {
                $('#sourceDatabaseName').html('<option value="">请先选择源连接器</option>');
                $('#sourceSchemaGroup').hide();
            }
        });

        // 目标连接器变化事件
        $('#targetConnectorId').change(function () {
            const connectorId = $(this).val();
            if (connectorId) {
                loadDatabases(connectorId, 'target');
                checkAndShowSchema(connectorId, 'target');
            } else {
                $('#targetDatabaseName').html('<option value="">请先选择目标连接器</option>');
                $('#sourceSchemaGroup').hide();
            }
        });

        // 源表选择变化事件
        $(document).on('change', '.source-table-select', function () {
            const tableIndex = $(this).data('table-index');
            const tableName = $(this).val();
            const connectorId = $('#sourceConnectorId').val();
            
            if (tableName && connectorId) {
                loadTableFields(connectorId, tableName, tableIndex, 'source');
            } else {
                clearTableFields(tableIndex, 'source');
            }
        });

        // 目标表选择变化事件
        $(document).on('change', '.target-table-select', function () {
            const tableIndex = $(this).data('table-index');
            const tableName = $(this).val();
            const connectorId = $('#targetConnectorId').val();
            
            if (tableName && connectorId) {
                loadTableFields(connectorId, tableName, tableIndex, 'target');
            } else {
                clearTableFields(tableIndex, 'target');
            }
        });



        // 添加表映射
        $('#addTableMappingBtn').click(function () {
            addTableMappingRow();
        });

        // 删除选中的表映射
        $('#removeTableMappingBtn').click(function () {
            removeSelectedTableMappings();
        });

        // 全选/取消全选表映射
        $('#selectAllMappings').change(function () {
            const isChecked = $(this).prop('checked');
            $('.table-mapping-checkbox').prop('checked', isChecked);
        });

        // 删除单个表映射
        $(document).on('click', '.remove-single-mapping', function () {
            $(this).closest('tr').remove();
            updateTableMappingIndexes();
            updateEmptyState();
        });
    });

    /**
     * 步骤切换函数
     */
    function goToStep(step) {
        console.log('[步骤切换] 切换到步骤:', step);
        console.log('[步骤切换] step1Content 存在:', $('#step1Content').length);
        console.log('[步骤切换] step2Content 存在:', $('#step2Content').length);
        currentStep = step;
        
        if (step === 1) {
            $('#step1Content').removeClass('hidden').css('display', 'block').show();
            $('#step2Content').addClass('hidden').css('display', 'none').hide();
            
            console.log('[步骤切换] 第一步显示状态:', $('#step1Content').is(':visible'));
            console.log('[步骤切换] 第二步显示状态:', $('#step2Content').is(':visible'));
            
            // 更新步骤指示器
            $('#step1Indicator').addClass('active');
            $('#step1Indicator .step-circle').css({
                'background': 'var(--primary-color)',
                'color': 'white'
            });
            $('#step1Indicator .step-label > div:first-child').css('color', 'var(--text-primary)');
            
            $('#step2Indicator').removeClass('active');
            $('#step2Indicator .step-circle').css({
                'background': '#e5e7eb',
                'color': '#9ca3af'
            });
            $('#step2Indicator .step-label > div:first-child').css('color', 'var(--text-secondary)');
            
        } else if (step === 2) {
            $('#step1Content').addClass('hidden').css('display', 'none').hide();
            $('#step2Content').removeClass('hidden').css('display', 'block').show();
            
            console.log('[步骤切换] 第一步显示状态:', $('#step1Content').is(':visible'));
            console.log('[步骤切换] 第二步显示状态:', $('#step2Content').is(':visible'));
            console.log('[步骤切换] 第二步样式:', $('#step2Content').attr('style'));
            
            // 更新步骤指示器
            $('#step1Indicator .step-circle').css({
                'background': 'var(--success-color)',
                'color': 'white'
            });
            $('#step1Indicator .step-label > div:first-child').css('color', 'var(--text-secondary)');
            
            $('#step2Indicator').addClass('active');
            $('#step2Indicator .step-circle').css({
                'background': 'var(--primary-color)',
                'color': 'white'
            });
            $('#step2Indicator .step-label > div:first-child').css('color', 'var(--text-primary)');
            
            // 更新连接线
            $('.step-line').css('background', 'var(--success-color)');
        }
        
        // 滚动到顶部
        window.scrollTo(0, 0);
    }

    /**
     * 构建第一步的配置（基础配置）
     */
    function buildStep1Config() {
        const formData = $('#taskAddForm').serializeArray();
        const config = {};

        // 基础配置
        formData.forEach(function (item) {
            if (item.name.includes('tableMappings')) {
                // 表映射配置跳过，第二步处理
                return;
            }

            if (item.name === 'trigger') {
                config[item.name] = item.value;
            } else if (item.name === 'cron' && config.trigger === 'timing') {
                config[item.name] = item.value;
            } else if (['autoMatchTable', 'verification', 'correction', 'tableStructure', 'rowData', 'index', 'triggerFlag', 'function', 'storedProcedure'].includes(item.name)) {
                config[item.name] = item.value === 'true';
            } else {
                config[item.name] = item.value;
            }
        });

        return config;
    }

    /**
     * 验证第一步并进入下一步（不保存到服务器）
     */
    function saveStep1AndGoNext() {
        console.log('[第一步] 开始验证基础配置');
        
        // 不执行表单验证，避免触发提交
        // 手动验证必填字段即可
        
        const config = buildStep1Config();

        console.log('[第一步] 配置数据:', config);
        
        // 验证必填字段
        if (!config.name) {
            console.warn('[第一步] 验证失败：缺少任务名称');
            if (typeof bootGrowl === 'function') {
                bootGrowl("请输入任务名称！", "danger");
            } else {
                alert("请输入任务名称！");
            }
            return false;
        }
        // 如果没有填写任务类型，使用默认值
        if (!config.type) {
            config.type = 'SYNC';
        }
        if (!config.sourceConnectorId) {
            console.warn('[第一步] 验证失败：缺少源连接器');
            if (typeof bootGrowl === 'function') {
                bootGrowl("请选择源连接器！", "danger");
            } else {
                alert("请选择源连接器！");
            }
            return false;
        }
        if (!config.targetConnectorId) {
            console.warn('[第一步] 验证失败：缺少目标连接器');
            if (typeof bootGrowl === 'function') {
                bootGrowl("请选择目标连接器！", "danger");
            } else {
                alert("请选择目标连接器！");
            }
            return false;
        }
        if (!config.sourceDatabaseName) {
            console.warn('[第一步] 验证失败：缺少源数据库');
            if (typeof bootGrowl === 'function') {
                bootGrowl("请输入源数据库名称！", "danger");
            } else {
                alert("请输入源数据库名称！");
            }
            return false;
        }
        if (!config.targetDatabaseName) {
            console.warn('[第一步] 验证失败：缺少目标数据库');
            if (typeof bootGrowl === 'function') {
                bootGrowl("请输入目标数据库名称！", "danger");
            } else {
                alert("请输入目标数据库名称！");
            }
            return false;
        }
        if (config.trigger === 'timing' && !config.cron) {
            console.warn('[第一步] 验证失败：缺少Cron表达式');
            if (typeof bootGrowl === 'function') {
                bootGrowl("定时触发模式下，请输入Cron表达式！", "danger");
            } else {
                alert("定时触发模式下，请输入Cron表达式！");
            }
            return false;
        }

        // 暂存第一步数据（不提交到服务器）
        step1Data = config;
        console.log('[第一步] 验证通过，数据已暂存:', step1Data);
        
        // 确保 DOM 元素存在
        console.log('[第一步] 检查DOM - step2Content 数量:', $('#step2Content').length);
        console.log('[第一步] 检查DOM - step2Content HTML长度:', $('#step2Content').html().length);
        
        if ($('#step2Content').length === 0) {
            console.error('[第一步] 错误：第二步的 DOM 元素不存在！');
            if (typeof bootGrowl === 'function') {
                bootGrowl("页面错误，请刷新后重试", "danger");
            } else {
                alert("页面错误，请刷新后重试");
            }
            return false;
        }
        
        // 显示成功消息
        if (typeof bootGrowl === 'function') {
            bootGrowl("基础配置验证通过！", "success");
        }
        
        // 加载表列表并进入第二步
        console.log('[第一步] 开始加载表列表');
        loadTablesForStep2(config);
        
        return false; // 确保不触发任何默认行为
    }

    /**
     * 保存第二步（表映射配置）并完成（一次性提交所有配置）
     */
    function saveStep2AndComplete() {
        console.log('[第二步] 开始保存表映射配置');
        
        // 检查第一步数据
        if (!step1Data) {
            bootGrowl("缺少第一步数据，请先完成第一步！", "danger");
            goToStep(1);
            return;
        }

        // 构建表映射配置
        const tableMappings = [];
        $('#tableMappingsContainer tr').each(function () {
            const $row = $(this);
            const sourceTableName = $row.find('select[name*="sourceTable.name"]').val();
            const sourceTableSchema = $row.find('input[name*="sourceTable.schema"]').val();
            const targetTableName = $row.find('select[name*="targetTable.name"]').val();
            const targetTableSchema = $row.find('input[name*="targetTable.schema"]').val();

            if (sourceTableName && targetTableName) {
                const tableMapping = {
                    sourceTable: {
                        name: sourceTableName,
                        schema: sourceTableSchema || 'public',
                        columns: []
                    },
                    targetTable: {
                        name: targetTableName,
                        schema: targetTableSchema || 'public',
                        columns: []
                    },
                    fieldMapping: []
                };
                
                tableMappings.push(tableMapping);
            }
        });

        if (tableMappings.length === 0) {
            bootGrowl("请至少配置一个表映射！", "danger");
            return;
        }

        // 合并第一步和第二步的配置
        const completeConfig = Object.assign({}, step1Data);
        completeConfig.tableMappings = tableMappings;
        
        console.log('[第二步] 完整配置:', completeConfig);
        console.log('[第二步] 表映射数量:', tableMappings.length);
        
        // 一次性提交所有配置创建任务
        // 不使用 showLoading/hideLoading，避免影响DOM
        $.ajax({
            url: $basePath + "/task/add",
            type: "POST",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify({
                name: completeConfig.name,
                type: completeConfig.type || 'SYNC',
                json: JSON.stringify(completeConfig)
            }),
            success: function (result) {
                console.log('[第二步] Ajax 响应结果:', result);
                
                if (result.success == true) {
                    savedTaskId = result.resultValue;
                    bootGrowl("任务创建完成！", "success");
                    console.log('[第二步] 保存成功，任务ID:', savedTaskId);
                    
                    // 返回任务列表
                    setTimeout(function () {
                        backTaskIndexPage();
                    }, 1000);
                } else {
                    bootGrowl(result.resultValue, "danger");
                }
            },
            error: function (xhr, status, info) {
                console.error('[第二步] Ajax 请求失败:', status, info);
                bootGrowl("访问异常，请刷新或重试.", "danger");
            }
        });
    }


    /**
     * 添加表映射行
     */
    function addTableMappingRow() {
        const index = tableMappingIndex++;
        const defaultSchema = step1Data.sourceSchema || 'public';
        const targetSchema = step1Data.targetSchema || 'public';
        
        const rowHtml = `
            <tr data-mapping-index="${index}">
                <td style="text-align: center;">
                    <input type="checkbox" class="table-mapping-checkbox" style="width: 16px; height: 16px; cursor: pointer;" />
                </td>
                <td>${index + 1}</td>
                <td>
                    <select class="form-control source-table-select select-control" 
                            name="tableMappings[${index}].sourceTable.name"
                            data-mapping-index="${index}" required
                            style="width: 100%;">
                        <option value="">请选择源表</option>
                    </select>
                    <input type="hidden" name="tableMappings[${index}].sourceTable.schema" value="${defaultSchema}" />
                </td>
                <td>
                    <select class="form-control target-table-select select-control"
                            name="tableMappings[${index}].targetTable.name"
                            data-mapping-index="${index}" required
                            style="width: 100%;">
                        <option value="">请选择目标表</option>
                    </select>
                    <input type="hidden" name="tableMappings[${index}].targetTable.schema" value="${targetSchema}" />
                </td>
                <td style="text-align: center;">
                    <button type="button" class="dbsyncer-btn dbsyncer-btn-danger dbsyncer-btn-sm remove-single-mapping"
                            title="删除此映射">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        
        $('#tableMappingsContainer').append(rowHtml);
        
        // 填充新添加行的表选择器
        const $newRow = $(`tr[data-mapping-index="${index}"]`);
        populateTableSelectsForRow($newRow);
        
        // 增强新添加的 select 元素
        if (typeof enhanceAllSelects === 'function') {
            enhanceAllSelects();
        }
        
        updateEmptyState();
    }
    
    /**
     * 为单行填充表选择器
     */
    function populateTableSelectsForRow($row) {
        if (!window.cachedSourceTables || !window.cachedTargetTables) {
            console.warn('[表映射] 缓存的表列表不存在');
            return;
        }
        
        // 填充源表选择器
        const $sourceSelect = $row.find('.source-table-select');
        let sourceOptions = '<option value="">请选择源表</option>';
        if (window.cachedSourceTables && window.cachedSourceTables.length > 0) {
            window.cachedSourceTables.forEach(function (table) {
                const tableName = table.name || table;
                const tableType = table.type || 'TABLE';
                sourceOptions += '<option value="' + tableName + '">' + tableName + ' (' + tableType + ')</option>';
            });
        }
        $sourceSelect.html(sourceOptions);
        
        // 填充目标表选择器
        const $targetSelect = $row.find('.target-table-select');
        let targetOptions = '<option value="">请选择目标表</option>';
        if (window.cachedTargetTables && window.cachedTargetTables.length > 0) {
            window.cachedTargetTables.forEach(function (table) {
                const tableName = table.name || table;
                const tableType = table.type || 'TABLE';
                targetOptions += '<option value="' + tableName + '">' + tableName + ' (' + tableType + ')</option>';
            });
        }
        $targetSelect.html(targetOptions);
    }
    
    /**
     * 删除选中的表映射
     */
    function removeSelectedTableMappings() {
        const $checked = $('.table-mapping-checkbox:checked');
        if ($checked.length === 0) {
            bootGrowl("请先选择要删除的表映射！", "warning");
            return;
        }
        
        $checked.each(function() {
            $(this).closest('tr').remove();
        });
        
        updateTableMappingIndexes();
        updateEmptyState();
        bootGrowl("已删除 " + $checked.length + " 个表映射", "success");
    }

    /**
     * 更新表映射索引
     */
    function updateTableMappingIndexes() {
        $('#tableMappingsContainer tr').each(function (index) {
            $(this).attr('data-mapping-index', index);
            $(this).find('td:eq(1)').text(index + 1);
            
            // 更新所有 input 和 select 的 name 属性
            $(this).find('input, select').each(function () {
                const name = $(this).attr('name');
                if (name) {
                    const newName = name.replace(/tableMappings\[\d+\]/, `tableMappings[${index}]`);
                    $(this).attr('name', newName);
                }
            });

            // 更新 data-mapping-index
            $(this).find('.source-table-select, .target-table-select').attr('data-mapping-index', index);
        });
        
        // 更新 tableMappingIndex
        tableMappingIndex = $('#tableMappingsContainer tr').length;
    }
    
    /**
     * 更新空状态提示
     */
    function updateEmptyState() {
        // 确保DOM元素存在
        if ($('#tableMappingsContainer').length === 0) {
            return;
        }
        
        const rowCount = $('#tableMappingsContainer tr').length;
        if (rowCount === 0) {
            $('#tableMappingTable').hide();
            $('#emptyTableMappingTip').show();
        } else {
            $('#tableMappingTable').show();
            $('#emptyTableMappingTip').hide();
        }
    }

    /**
     * 显示Cron表达式帮助
     */
    function showCronHelp() {
        const helpText = `
            <div class="alert alert-info">
                <h4>Cron表达式格式说明：</h4>
                <p>格式：秒 分 时 日 月 周</p>
                <ul>
                    <li>秒：0-59</li>
                    <li>分：0-59</li>
                    <li>时：0-23</li>
                    <li>日：1-31</li>
                    <li>月：1-12 或 JAN-DEC</li>
                    <li>周：0-7 或 SUN-SAT (0和7都表示周日)</li>
                </ul>
                <h5>常用示例：</h5>
                <ul>
                    <li>每天凌晨1点：0 0 1 * * ?</li>
                    <li>每小时执行：0 0 * * * ?</li>
                    <li>每天上午10点：0 0 10 * * ?</li>
                    <li>每周一上午9点：0 0 9 ? * MON</li>
                </ul>
            </div>
        `;

        bootbox.alert({
            title: "Cron表达式帮助",
            message: helpText,
            size: 'large'
        });
    }

    /**
     * 加载数据库列表
     */
    function loadDatabases(connectorId, type) {
        console.log('[加载数据库] 连接器ID:', connectorId, '类型:', type);
        
        // 显示加载状态
        const selectId = type === 'source' ? '#sourceDatabaseName' : '#targetDatabaseName';
        $(selectId).html('<option value="">加载中...</option>');
        
        $.ajax({
            url: $basePath + "/connector/getDatabases",
            type: "GET",
            dataType: "json",
            data: { connectorId: connectorId },
            success: function (result) {
                console.log('[加载数据库] 响应结果:', result);
                
                if (result.success) {
                    let options = '<option value="">请选择数据库</option>';
                    
                    if (result.resultValue && result.resultValue.length > 0) {
                        result.resultValue.forEach(function (db) {
                            options += '<option value="' + db + '">' + db + '</option>';
                        });
                        console.log('[加载数据库] 成功加载 ' + result.resultValue.length + ' 个数据库');
                    } else {
                        console.warn('[加载数据库] 数据库列表为空');
                        options = '<option value="">暂无数据库</option>';
                    }
                    
                    $(selectId).html(options);
                    
                    // 增强更新后的 select 元素
                    if (typeof enhanceAllSelects === 'function') {
                        enhanceAllSelects();
                    }
                    
                    // 加载表列表
                    loadTables(connectorId, type);
                } else {
                    console.error('[加载数据库] 失败:', result.resultValue);
                    $(selectId).html('<option value="">加载失败</option>');
                    bootGrowl("获取数据库列表失败: " + result.resultValue, "danger");
                }
            },
            error: function (xhr, status, error) {
                console.error('[加载数据库] 请求异常:', status, error);
                $(selectId).html('<option value="">加载失败</option>');
                bootGrowl("获取数据库列表失败: " + error, "danger");
            }
        });
    }

    /**
     * 加载表列表（第一步中使用）
     */
    function loadTables(connectorId, type) {
        $.ajax({
            url: $basePath + "/task/getTables",
            type: "GET",
            dataType: "json",
            data: {
                connectorId: connectorId,
                database: '',
                schema: ''
            },
            success: function (result) {
                if (result.success) {
                    const tableSelects = type === 'source' ? '.source-table-select' : '.target-table-select';
                    
                    $(tableSelects).each(function () {
                        let options = '<option value="">请选择表</option>';
                        
                        if (result.resultValue && result.resultValue.length > 0) {
                            result.resultValue.forEach(function (table) {
                                options += '<option value="' + table.name + '">' + table.name + '</option>';
                            });
                        }
                        
                        $(this).html(options);
                    });
                    
                    // 增强更新后的 select 元素
                    if (typeof enhanceAllSelects === 'function') {
                        enhanceAllSelects();
                    }
                } else {
                    bootGrowl("获取表列表失败: " + result.resultValue, "danger");
                }
            },
            error: function () {
                bootGrowl("获取表列表失败", "danger");
            }
        });
    }

    /**
     * 为第二步加载表列表
     */
    function loadTablesForStep2(config) {
        console.log('[第二步] 开始加载表列表');
        // 不调用 showLoading()，避免清空DOM
        
        // 同时加载源表和目标表
        let sourceTablesLoaded = false;
        let targetTablesLoaded = false;
        let sourceTables = [];
        let targetTables = [];
        
        // 加载源表
        $.ajax({
            url: $basePath + "/task/getTables",
            type: "GET",
            dataType: "json",
            data: {
                connectorId: config.sourceConnectorId,
                database: config.sourceDatabaseName || '',
                schema: config.sourceSchema || ''
            },
            success: function (result) {
                console.log('[第二步] 源表加载成功:', result);
                sourceTablesLoaded = true;
                if (result.success && result.resultValue) {
                    sourceTables = result.resultValue;
                }
                checkBothLoaded();
            },
            error: function (xhr, status, error) {
                console.error('[第二步] 源表加载失败:', status, error);
                sourceTablesLoaded = true;
                checkBothLoaded();
            }
        });
        
        // 加载目标表
        $.ajax({
            url: $basePath + "/task/getTables",
            type: "GET",
            dataType: "json",
            data: {
                connectorId: config.targetConnectorId,
                database: config.targetDatabaseName || '',
                schema: config.targetSchema || ''
            },
            success: function (result) {
                console.log('[第二步] 目标表加载成功:', result);
                targetTablesLoaded = true;
                if (result.success && result.resultValue) {
                    targetTables = result.resultValue;
                }
                checkBothLoaded();
            },
            error: function (xhr, status, error) {
                console.error('[第二步] 目标表加载失败:', status, error);
                targetTablesLoaded = true;
                checkBothLoaded();
            }
        });
        
        // 检查是否都加载完成
        function checkBothLoaded() {
            if (sourceTablesLoaded && targetTablesLoaded) {
                // 不调用 hideLoading()，避免影响DOM
                
                console.log('[第二步] 表列表加载完成，源表数量:', sourceTables.length, '目标表数量:', targetTables.length);
                
                // 先切换到第二步
                goToStep(2);
                
                // 然后填充表选择器（确保DOM已经显示）
                setTimeout(function() {
                    populateTableSelects(sourceTables, targetTables);
                    console.log('[第二步] 已切换到第二步，表列表已填充');
                }, 100);
            }
        }
    }
    
    /**
     * 填充表选择器
     */
    function populateTableSelects(sourceTables, targetTables) {
        console.log('[第二步] 填充表选择器，源表数量:', sourceTables.length, '目标表数量:', targetTables.length);
        
        // 再次确保第二步是可见的
        const $step2 = $('#step2Content');
        console.log('[第二步] 填充前检查 - step2Content 存在:', $step2.length);
        console.log('[第二步] 填充前检查 - step2Content 可见:', $step2.is(':visible'));
        console.log('[第二步] 填充前检查 - step2Content 类名:', $step2.attr('class'));
        
        // 强制显示第二步
        $step2.removeClass('hidden');
        $step2.attr('style', 'display: block !important; visibility: visible; opacity: 1;');
        $step2.show();
        
        console.log('[第二步] 填充后检查 - step2Content 可见:', $step2.is(':visible'));
        
        // 缓存表列表，供后续添加新行时使用
        window.cachedSourceTables = sourceTables;
        window.cachedTargetTables = targetTables;
        
        // 填充源表选择器
        const sourceSelectCount = $('.source-table-select').length;
        console.log('[第二步] 源表选择器数量:', sourceSelectCount);
        
        $('.source-table-select').each(function () {
            let options = '<option value="">请选择源表</option>';
            if (sourceTables && sourceTables.length > 0) {
                sourceTables.forEach(function (table) {
                    const tableName = table.name || table;
                    const tableType = table.type || 'TABLE';
                    options += '<option value="' + tableName + '">' + tableName + ' (' + tableType + ')</option>';
                });
            }
            $(this).html(options);
        });
        
        // 填充目标表选择器
        const targetSelectCount = $('.target-table-select').length;
        console.log('[第二步] 目标表选择器数量:', targetSelectCount);
        
        $('.target-table-select').each(function () {
            let options = '<option value="">请选择目标表</option>';
            if (targetTables && targetTables.length > 0) {
                targetTables.forEach(function (table) {
                    const tableName = table.name || table;
                    const tableType = table.type || 'TABLE';
                    options += '<option value="' + tableName + '">' + tableName + ' (' + tableType + ')</option>';
                });
            }
            $(this).html(options);
        });
        
        // 增强更新后的 select 元素
        if (typeof enhanceAllSelects === 'function') {
            enhanceAllSelects();
        }
        
        // 显示空状态提示（初始化时没有表映射）
        updateEmptyState();
    }

    /**
     * 加载表字段
     */
    function loadTableFields(connectorId, tableName, tableIndex, type) {
        $.ajax({
            url: $basePath + "/task/getTableFields",
            type: "GET",
            dataType: "json",
            data: { 
                connectorId: connectorId,
                tableName: tableName
            },
            success: function (result) {
                if (result.success) {
                    const fieldSelects = type === 'source' ? 
                        '.source-field-select[data-table-index="' + tableIndex + '"]' : 
                        '.target-field-select[data-table-index="' + tableIndex + '"]';
                    
                    $(fieldSelects).each(function () {
                        let options = '<option value="">请选择字段</option>';
                        
                        if (result.resultValue && result.resultValue.length > 0) {
                            result.resultValue.forEach(function (field) {
                                options += '<option value="' + field.getName() + '">' + 
                                    field.getName() + ' (' + field.getTypeName() + ')</option>';
                            });
                        }
                        
                        $(this).html(options);
                    });
                    
                    // 增强更新后的 select 元素
                    if (typeof enhanceAllSelects === 'function') {
                        enhanceAllSelects();
                    }
                } else {
                    bootGrowl("获取表字段失败: " + result.resultValue, "danger");
                }
            },
            error: function () {
                bootGrowl("获取表字段失败", "danger");
            }
        });
    }

    /**
     * 清空表字段
     */
    function clearTableFields(tableIndex, type) {
        const fieldSelects = type === 'source' ? 
            '.source-field-select[data-table-index="' + tableIndex + '"]' : 
            '.target-field-select[data-table-index="' + tableIndex + '"]';
        
        $(fieldSelects).html('<option value="">请选择字段</option>');
    }

    /**
     * 检查并显示Schema输入框
     */
    function checkAndShowSchema(connectorId, type) {
        $.ajax({
            url: $basePath + "/task/getConnectorType",
            type: "GET",
            dataType: "json",
            data: { connectorId: connectorId },
            success: function (result) {
                if (result.success) {
                    const connectorType = result.resultValue.toLowerCase();
                    let showSchema = false;
                    let defaultSchema = '';
                    
                    if (connectorType.includes('oracle')) {
                        showSchema = true;
                        defaultSchema = 'SYSTEM';
                    } else if (connectorType.includes('postgresql')) {
                        showSchema = true;
                        defaultSchema = 'public';
                    } else if (connectorType.includes('sqlserver')) {
                        showSchema = true;
                        defaultSchema = 'dbo';
                    }
                    
                    if (showSchema) {
                        $('#sourceSchemaGroup').show();
                        if (type === 'source') {
                            $('#sourceSchema').val(defaultSchema);
                        } else {
                            $('#targetSchema').val(defaultSchema);
                        }
                    } else {
                        $('#sourceSchemaGroup').hide();
                    }
                }
            },
            error: function () {
                console.error("获取连接器类型失败");
            }
        });
    }

    /**
     * 构建JSON配置
     */
    function buildTaskConfig() {
        const formData = $('#taskAddForm').serializeArray();
        const config = {};

        // 基础配置
        formData.forEach(function (item) {
            if (item.name.includes('tableMappings')) {
                // 表映射配置，稍后处理
                return;
            }

            if (item.name === 'trigger') {
                config[item.name] = item.value;
            } else if (item.name === 'cron' && config.trigger === 'timing') {
                config[item.name] = item.value;
            } else if (['autoMatchTable', 'verification', 'correction', 'tableStructure', 'rowData', 'index', 'triggerFlag', 'function', 'storedProcedure'].includes(item.name)) {
                config[item.name] = item.value === 'true';
            } else {
                config[item.name] = item.value;
            }
        });

        // 处理表映射
        config.tableMappings = [];
        $('.table-mapping-item').each(function () {
            const tableMapping = {
                sourceTable: {
                    name: $(this).find('select[name*="sourceTable.name"]').val(),
                    schema: $(this).find('input[name*="sourceTable.schema"]').val(),
                    columns: []
                },
                targetTable: {
                    name: $(this).find('select[name*="targetTable.name"]').val(),
                    schema: $(this).find('input[name*="targetTable.schema"]').val(),
                    columns: []
                },
                fieldMapping: []
            };

            // 处理字段映射
            $(this).find('.field-mapping-item').each(function () {
                const sourceField = $(this).find('select[name*="sourceField"]').val();
                const targetField = $(this).find('select[name*="targetField"]').val();
                const typeHandler = $(this).find('select[name*="typeHandler"]').val();

                if (sourceField && targetField) {
                    tableMapping.fieldMapping.push({
                        sourceField: sourceField,
                        targetField: targetField,
                        typeHandler: typeHandler
                    });
                }
            });

            if (tableMapping.sourceTable.name && tableMapping.targetTable.name) {
                config.tableMappings.push(tableMapping);
            }
        });

        return config;
    }

    /**
     * 返回任务列表页面
     */
    function backTaskIndexPage() {
        doLoader("/task?refresh=" + new Date().getTime());
    }

    // 注意：原来的一步提交按钮事件已被分步提交代替
    // 如需恢复一步提交，取消下面代码的注释并隐藏步骤指示器
    /*
    $("#taskSubmitBtn").click(function () {
        const $form = $("#taskAddForm");
        if ($form.formValidate() == true) {
            const config = buildTaskConfig();
            // ... 原来的提交逻辑
        }
    });
    */

    // 原来的返回按钮事件（已被步骤按钮代替）
    /*
    $("#taskBackBtn").click(function () {
        backTaskIndexPage();
    });
    */
</script>

</html>