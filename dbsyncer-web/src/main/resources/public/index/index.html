<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<!-- ProjectGroup Connector Mapping -->
<div class="container-fluid">
    <div class="row">
        <form class="form-horizontal" role="form" method="post">

            <!-- 分组管理竖排显示 -->
            <div class="col-md-2">
                <!-- 分组管理竖排显示 -->
                <div class="panel panel-default">
                    <div class="panel-heading" style="text-align: left; padding-left: 15px;">
                        <h3 class="panel-title" style="display: inline-block;">分组管理</h3>
                        <button type="button" style="display: inline-block;margin-left:24px" class="btn btn-default "
                            id="addProjectGroupBtn">
                            <span class="fa fa-plus"></span>添加分组([[${projectGroups?.size()} ?: 0]])
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <div class="btn-group-vertical" style="width: 100%;">
                                <style>
                                    .btn-group-vertical > div:hover > div {
                                        opacity: 1 !important;
                                    }
                                    .active-group-item {
                                        background-color: #e6e6e6;
                                        font-weight: bold;
                                    }
                                </style>
                                <div style="display: flex; align-items: center; padding: 8px 15px; position: relative; border-bottom: 1px solid #e0e0e0;"
                                    th:classappend="${#strings.isEmpty(projectGroupId)} ? 'active-group-item'">
                                    <img th:src="@{/img/File.png}"
                                        style="width: 16px; height: 16px; margin-right: 10px;" />
                                    <span style="vertical-align: middle;">&nbsp;★&nbsp;未分配</span>
                                    <button type="button" class="btn btn-default btn-block text-left"
                                        th:onclick="groupShow('')" 
                                        style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                    </button>
                                </div>
                                <div th:each="g,s:${projectGroups}" style="display: flex; align-items: center; padding: 8px 15px; position: relative; border-bottom: 1px solid #e0e0e0;"
                                    th:classappend="${g?.id eq projectGroupId} ? 'active-group-item'">
                                    <img th:src="@{/img/File.png}"
                                        style="width: 16px; height: 16px; margin-right: 10px;" />
                                    <span style="vertical-align: middle;">&nbsp;★&nbsp;<span
                                        th:text="${g?.name}"></span></span>
                                    <button type="button" 
                                        th:attr="onclick='groupShow(\'' + ${g?.id} + '\')'"
                                        style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                    </button>
                                    <div style="position: absolute; right: 0; top: 0; width: 40px; height: 100%; opacity: 0; transition: opacity 0.2s ease-in-out;">
                                        <div class="dropdown" style="height: 100%;">
                                            <button type="button" class="btn dropdown-toggle"
                                                data-toggle="dropdown"
                                                style="padding: 6px 8px; margin: 0; width: 40px; height: 100%; border: none; background: transparent;">
                                                <span class="fa fa-ellipsis-v"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-right" style="min-width: 80px; width: auto;">
                                                <li><a href="javascript:;"
                                                        th:attr="onclick='doEditProjectGroup(\'' + ${g?.id} + '\')'"
                                                        style="padding: 5px 10px;">
                                                        <span class="fa fa-pencil"></span> 修改</a></li>
                                                <li><a href="javascript:;"
                                                        th:attr="onclick='doRemoveProjectGroup(\'' + ${g?.id} + '\')'"
                                                        style="padding: 5px 10px;">
                                                        <span class="fa fa-times"></span> 删除</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" th:value="${projectGroupId}" th:name="projectGroup"
                                    id="projectGroup">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <!-- 任务管理 -->
                <div class="col-md-12">
                    <!-- 任务开始位置 -->
                    <div class="form-group" th:if="${connectorSize gt 0}">
                        <div class="col-md-12" style="display: flex; align-items: center; gap: 20px;">
                            <button type="button" class="btn btn-primary" id="indexAddMappingBtn">
                                <span class="fa fa-plus"></span>添加任务([[${mappings?.size()} ?: 0]])
                            </button>
                            
                            <!-- 布局切换按钮 -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-default active" id="listViewBtn" title="列表视图">
                                    <i class="fa fa-list"></i>
                                </button>
                                <button type="button" class="btn btn-default" id="cardViewBtn" title="卡片视图">
                                    <i class="fa fa-th-large"></i>
                                </button>
                            </div>
                            
                            <!-- 搜索框 -->
                            <div class="input-group" style="width: 200px;">
                                <input type="text" class="form-control" id="mappingSearchInput" placeholder="搜索任务..."
                                    style="border-radius: 4px 0 0 4px;" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default" id="mappingSearchBtn" type="button"
                                        style="border-radius: 0 4px 4px 0; margin-left: -1px;">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                            
                            <!-- 三个下拉框 -->
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span>状态：</span>
                                    <select class="form-control input-sm" id="filterState" style="width: 80px;">
                                        <option value="">全部</option>
                                        <option value="0">未开始</option>
                                        <option value="1">进行中</option>
                                        <option value="3">异常</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span>数据源：</span>
                                    <select class="form-control input-sm" id="filterSource" style="width: 100px;">
                                        <option value="">全部</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span>目标源：</span>
                                    <select class="form-control input-sm" id="filterTarget" style="width: 100px;">
                                        <option value="">全部</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 无搜索结果提示 -->
                    <div id="noSearchResults" class="alert alert-info" style="display: none; margin-top: 20px;">
                        <strong>提示：</strong>没有找到匹配的任务，请尝试其他关键词。
                    </div>
                    <!-- 显示任务列表 -->
                    <div class="row" th:if="${mappings?.size() gt 0}">
                        <!-- 列表视图 -->
                        <div id="listView" class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped">
                                            <thead>
                                                <tr>
                                                    <th>名称</th>
                                                    <th>运行状态</th>
                                                    <th>起始源</th>
                                                    <th>目标源</th>
                                                    <th>同步类型</th>
                                                    <th>操作</th>
                                                    <th>创建时间</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="m,state : ${mappings}" th:id="${m?.id}">
                                                    <!-- 名称 -->
                                                    <td th:text="${m?.name}" th:title="${m?.name}"
                                                        style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    </td>

                                                    <!-- 运行状态 -->
                                                    <td>
                                                        <span th:if="${m?.meta?.state eq 0}"
                                                            class="label label-info">未运行</span>
                                                        <span th:if="${m?.meta?.state eq 1}"
                                                            class="label label-success">运行中</span>
                                                        <span th:if="${m?.meta?.state eq 2}"
                                                            class="label label-warning">停止中</span>
                                                        <span th:if="${m?.meta?.state eq 3}"
                                                            class="label label-danger">异常</span>
                                                        <!-- 任务异常提示 -->
                                                        <span th:if="${m?.meta?.state eq 3}"
                                                            th:title="${m?.meta?.errorMessage}"
                                                            class="mapping-error-sign" data-toggle="tooltip"
                                                            data-placement="top"><i
                                                                class="fa fa-exclamation-triangle"></i></span>
                                                    </td>

                                                    <!-- 起始源 -->
                                                    <td>
                                                        <div class="dbsyncer_over_hidden"
                                                            style="display: flex; align-items: center;">
                                                            <img draggable="false"
                                                                th:src="@{'/img/'+ ${m?.sourceConnector?.config?.connectorType} + '.png'}"
                                                                style="width: 20px; height: 20px; margin-right: 5px;">
                                                            <span th:text="${m?.sourceConnector?.name}"
                                                                th:title="${m?.sourceConnector?.name}"></span>
                                                            <span th:if="${m?.sourceConnector?.running}" th:title="连接正常"
                                                                style="margin-left: 5px;"><i
                                                                    class="fa fa-circle well-sign-green"></i></span>
                                                            <span th:unless="${m?.sourceConnector?.running}"
                                                                th:title="连接异常" style="margin-left: 5px;"><i
                                                                    class="fa fa-times-circle-o well-sign-red"></i></span>
                                                        </div>
                                                    </td>

                                                    <!-- 目标源 -->
                                                    <td>
                                                        <div class="dbsyncer_over_hidden"
                                                            style="display: flex; align-items: center;">
                                                            <img draggable="false"
                                                                th:src="@{'/img/'+ ${m?.targetConnector?.config?.connectorType} + '.png'}"
                                                                style="width: 20px; height: 20px; margin-right: 5px;">
                                                            <span th:text="${m?.targetConnector?.name}"
                                                                th:title="${m?.targetConnector?.name}"></span>
                                                            <span th:if="${m?.targetConnector?.running}" th:title="连接正常"
                                                                style="margin-left: 5px;"><i
                                                                    class="fa fa-circle well-sign-green"></i></span>
                                                            <span th:unless="${m?.targetConnector?.running}"
                                                                th:title="连接异常" style="margin-left: 5px;"><i
                                                                    class="fa fa-times-circle-o well-sign-red"></i></span>
                                                        </div>
                                                    </td>

                                                    <!-- 同步类型 -->
                                                    <td th:text="${m?.meta?.model}"></td>

                                                    <!-- 操作 -->
                                                    <td>
                                                        <div class="operation-buttons">
                                                            <!-- 未运行 -->
                                                            <a th:if="${m?.meta?.state ne 1}"
                                                                th:attr="data-url='/mapping/start?id='+${m?.id}"
                                                                href="javascript:;"
                                                                class="btn btn-xs btn-primary margin-right-5"><i
                                                                    class="fa fa-check-circle-o"></i> 启动</a>
                                                            <!-- 运行中 -->
                                                            <a th:if="${m?.meta?.state eq 1}"
                                                                th:attr="data-url='/mapping/stop?id='+${m?.id}"
                                                                href="javascript:;"
                                                                class="btn btn-xs btn-warning margin-right-5"><i
                                                                    class="fa fa-times-circle-o"></i> 停止</a>
                                                            <a href="javascript:;"
                                                                th:attr="data-url='/mapping/page/edit?classOn=0&id='+${m?.id}"
                                                                class="btn btn-xs btn-primary margin-right-5"><i
                                                                    class="fa fa-eye"></i> 详情</a>
                                                        </div>
                                                    </td>

                                                    <!-- 创建时间 -->
                                                    <td
                                                        th:text="${#dates.format(m?.updateTime, 'yyyy-MM-dd HH:mm:ss')}">
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 卡片视图 -->
                        <div id="cardView" class="col-md-12" style="display: none;">
                            <div class="row mappingList">
                                <div th:each="m,state : ${mappings}" th:id="${m?.id}" class="col-md-2 mb-3" style="max-width: 20%; flex: 0 0 20%; padding: 0 2px;">
                                    <div class="panel panel-default dbsyncer_block" style="height: 260px; display: flex; flex-direction: column; width: 100%; margin: 0; cursor: pointer;" th:attr="data-id=${m?.id}">
                                        <div class="panel-body" style="flex: 1; display: flex; flex-direction: column; font-size: 16px; padding: 10px;">
                                            <!-- 任务信息头部 -->
                                            <div class="text-center mb-4">
                                                <h4 th:text="${m?.name}" class="text-primary" style="margin: 0; font-size: 20px;"></h4>
                                                <div id="stateId" class="mt-2" style="font-size: 14px;">
                                                    <span th:if="${m?.meta?.state eq 0}"
                                                        class="label label-info">未运行</span>
                                                    <span th:if="${m?.meta?.state eq 1}"
                                                        class="label label-success">运行中</span>
                                                    <span th:if="${m?.meta?.state eq 2}"
                                                        class="label label-warning">停止中</span>
                                                    <span th:if="${m?.meta?.state eq 3}"
                                                        class="label label-danger">异常</span>
                                                    <!-- 任务异常提示 -->
                                                    <span th:if="${m?.meta?.state eq 3}"
                                                        th:title="${m?.meta?.errorMessage}"
                                                        class="mapping-error-sign" data-toggle="tooltip"
                                                        data-placement="top"><i
                                                            class="fa fa-exclamation-triangle"></i></span>
                                                </div>
                                            </div>
                                            
                                            <!-- 同步类型 -->
                                            <div class="mb-3 border rounded" style="background-color: #f8f9fa; padding: 8px;">
                                                <span class="text-muted">同步类型：</span>
                                                <span th:text="${m?.meta?.model}"></span>
                                            </div>
                                            
                                            <!-- 连接信息 -->
                                            <div class="mb-4 flex-grow-1">
                                                <div class="border rounded mb-2" style="background-color: #f8f9fa; display: flex; align-items: center; padding: 8px; white-space: nowrap; overflow: hidden;">
                                                    <img draggable="false"
                                                        th:src="@{'/img/'+ ${m?.sourceConnector?.config?.connectorType} + '.png'}"
                                                        style="width: 16px; height: 16px; margin-right: 3px;">
                                                    <span th:text="${m?.sourceConnector?.name}"
                                                        th:title="${m?.sourceConnector?.name}" style="margin-right: 3px; overflow: hidden; text-overflow: ellipsis; flex: 1;"></span>
                                                    <span th:if="${m?.sourceConnector?.running}" th:title="连接正常"
                                                        style="margin-left: 0;"><i
                                                            class="fa fa-circle well-sign-green"></i></span>
                                                    <span th:unless="${m?.sourceConnector?.running}"
                                                        th:title="连接异常" style="margin-left: 0;"><i
                                                            class="fa fa-times-circle-o well-sign-red"></i></span>
                                                </div>
                                                
                                                <div class="my-1" style="margin-left: 5px;">
                                                    <i class="fa fa-arrow-down text-muted"></i>
                                                </div>
                                                
                                                <div class="border rounded" style="background-color: #f8f9fa; display: flex; align-items: center; padding: 8px; white-space: nowrap; overflow: hidden;">
                                                    <img draggable="false"
                                                        th:src="@{'/img/'+ ${m?.targetConnector?.config?.connectorType} + '.png'}"
                                                        style="width: 16px; height: 16px; margin-right: 3px;">
                                                    <span th:text="${m?.targetConnector?.name}"
                                                        th:title="${m?.targetConnector?.name}" style="margin-right: 3px; overflow: hidden; text-overflow: ellipsis; flex: 1;"></span>
                                                    <span th:if="${m?.targetConnector?.running}" th:title="连接正常"
                                                        style="margin-left: 0;"><i
                                                            class="fa fa-circle well-sign-green"></i></span>
                                                    <span th:unless="${m?.targetConnector?.running}"
                                                        th:title="连接异常" style="margin-left: 0;"><i
                                                            class="fa fa-times-circle-o well-sign-red"></i></span>
                                                </div>
                                            </div>
                                            
                                            <!-- 操作按钮 -->
                                            <div class="pt-4" style="margin-top: auto;">
                                                <div class="operation-buttons" style="display: flex; justify-content: center; gap: 15px;">
                                                    <!-- 未运行 -->
                                                    <a th:if="${m?.meta?.state ne 1}"
                                                        th:attr="data-url='/mapping/start?id='+${m?.id}"
                                                        href="javascript:;"
                                                        class="btn btn-sm btn-primary" style="min-width: 100px;"><i
                                                            class="fa fa-check-circle-o"></i> 启动任务</a>
                                                    <!-- 运行中 -->
                                                    <a th:if="${m?.meta?.state eq 1}"
                                                        th:attr="data-url='/mapping/stop?id='+${m?.id}"
                                                        href="javascript:;"
                                                        class="btn btn-sm btn-warning" style="min-width: 100px;"><i
                                                            class="fa fa-times-circle-o"></i> 停止任务</a>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 任务结束位置 -->
                </div>
            </div>

        </form>
    </div>
</div>

<script th:src="@{/js/index/index.js}"></script>

</html>