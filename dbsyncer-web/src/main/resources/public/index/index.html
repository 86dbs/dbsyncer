<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<!-- ProjectGroup Connector Mapping -->
<div class="container-fluid">
    <div class="row">
        <form class="form-horizontal" role="form" method="post">

            <!-- 分组管理竖排显示 -->
            <div class="col-md-3">
                <!-- 分组管理竖排显示 -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title" style="display: inline-block;">分组管理</h3>
                        <button type="button" style="display: inline-block;margin-left:24px" class="btn btn-default "
                            id="addProjectGroupBtn">
                            <span class="fa fa-plus"></span>添加分组([[${projectGroups?.size()} ?: 0]])
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <div class="btn-group-vertical" style="width: 100%;">
                                <button type="button" class="btn btn-default btn-block text-left"
                                    th:classappend="${#strings.isEmpty(projectGroupId)} ? 'active'"
                                    th:onclick="groupShow('')" style="padding-left: 30px; position: relative;">
                                    <img th:src="@{/img/File.png}"
                                        style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px;" />
                                    <span style="vertical-align: middle;">&nbsp;★&nbsp;未分配</span>
                                </button>
                                <div th:each="g,s:${projectGroups}" class="btn-group btn-block"
                                    style="display: inline-block;">
                                    <button type="button" class="btn btn-default btn-block text-left"
                                        th:classappend="${g?.id eq projectGroupId} ? 'active'"
                                        th:attr="onclick='groupShow(\'' + ${g?.id} + '\')'"
                                        style="width: calc(100% - 40px); display: inline-block; float: left; border-top-right-radius: 0; border-bottom-right-radius: 0; padding-left: 30px; position: relative;">
                                        <img th:src="@{/img/File.png}"
                                            style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px;" />
                                            <span style="vertical-align: middle;">&nbsp;★&nbsp;<span
                                                th:text="${g?.name}"></span></span>
                                    </button>
                                    <div style="display: inline-block; width: 40px; float: right;">
                                        <div class="dropdown">
                                            <button type="button" class="btn btn-default dropdown-toggle"
                                                data-toggle="dropdown"
                                                style="padding: 6px 8px; margin: 0; width: 40px; border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                                <span class="fa fa-ellipsis-v"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-right">
                                                <li><a href="javascript:;"
                                                        th:attr="onclick='doEditProjectGroup(\'' + ${g?.id} + '\')'">
                                                        <span class="fa fa-pencil"></span> 修改</a></li>
                                                <li><a href="javascript:;"
                                                        th:attr="onclick='doRemoveProjectGroup(\'' + ${g?.id} + '\')'">
                                                        <span class="fa fa-times"></span> 删除</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" th:value="${projectGroupId}" th:name="projectGroup"
                                    id="projectGroup">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <!-- 任务管理 -->
                <div class="col-md-12">
                    <!-- 任务开始位置 -->
                    <div class="form-group" th:if="${connectorSize gt 0}">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" id="indexAddMappingBtn">
                                <span class="fa fa-plus"></span>添加任务([[${mappings?.size()} ?: 0]])
                            </button>
                            
                            <!-- 布局切换按钮 -->
                            <div class="btn-group" style="margin-left: 10px;">
                                <button type="button" class="btn btn-default active" id="listViewBtn" title="列表视图">
                                    <i class="fa fa-list"></i>
                                </button>
                                <button type="button" class="btn btn-default" id="cardViewBtn" title="卡片视图">
                                    <i class="fa fa-th-large"></i>
                                </button>
                            </div>
                            
                            <div class="input-group" style="display: inline-flex; width: 300px; margin-left: 20px;">
                                <input type="text" class="form-control" id="mappingSearchInput" placeholder="按名称搜索任务..."
                                    style="border-radius: 4px 0 0 4px;" />
                                <span class="input-group-btn" style="display: inline;">
                                    <button class="btn btn-default" id="mappingSearchBtn" type="button"
                                        style="border-radius: 0 4px 4px 0; margin-left: -1px;">
                                        <i class="fa fa-search"></i> 搜索
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 无搜索结果提示 -->
                    <div id="noSearchResults" class="alert alert-info" style="display: none; margin-top: 20px;">
                        <strong>提示：</strong>没有找到匹配的任务，请尝试其他关键词。
                    </div>
                    <!-- 显示任务列表 -->
                    <div class="row" th:if="${mappings?.size() gt 0}">
                        <!-- 列表视图 -->
                        <div id="listView" class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped">
                                            <thead>
                                                <tr>
                                                    <th>名称</th>
                                                    <th>运行状态</th>
                                                    <th>起始源</th>
                                                    <th>目标源</th>
                                                    <th>同步类型</th>
                                                    <th>操作</th>
                                                    <th>创建时间</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="m,state : ${mappings}" th:id="${m?.id}">
                                                    <!-- 名称 -->
                                                    <td th:text="${m?.name}" th:title="${m?.name}"
                                                        style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    </td>

                                                    <!-- 运行状态 -->
                                                    <td>
                                                        <span th:if="${m?.meta?.state eq 0}"
                                                            class="label label-info">未运行</span>
                                                        <span th:if="${m?.meta?.state eq 1}"
                                                            class="label label-success">运行中</span>
                                                        <span th:if="${m?.meta?.state eq 2}"
                                                            class="label label-warning">停止中</span>
                                                        <span th:if="${m?.meta?.state eq 3}"
                                                            class="label label-danger">异常</span>
                                                        <!-- 任务异常提示 -->
                                                        <span th:if="${m?.meta?.state eq 3}"
                                                            th:title="${m?.meta?.errorMessage}"
                                                            class="mapping-error-sign" data-toggle="tooltip"
                                                            data-placement="top"><i
                                                                class="fa fa-exclamation-triangle"></i></span>
                                                    </td>

                                                    <!-- 起始源 -->
                                                    <td>
                                                        <div class="dbsyncer_over_hidden"
                                                            style="display: flex; align-items: center;">
                                                            <img draggable="false"
                                                                th:src="@{'/img/'+ ${m?.sourceConnector?.config?.connectorType} + '.png'}"
                                                                style="width: 20px; height: 20px; margin-right: 5px;">
                                                            <span th:text="${m?.sourceConnector?.name}"
                                                                th:title="${m?.sourceConnector?.name}"></span>
                                                            <span th:if="${m?.sourceConnector?.running}" th:title="连接正常"
                                                                style="margin-left: 5px;"><i
                                                                    class="fa fa-circle well-sign-green"></i></span>
                                                            <span th:unless="${m?.sourceConnector?.running}"
                                                                th:title="连接异常" style="margin-left: 5px;"><i
                                                                    class="fa fa-times-circle-o well-sign-red"></i></span>
                                                        </div>
                                                    </td>

                                                    <!-- 目标源 -->
                                                    <td>
                                                        <div class="dbsyncer_over_hidden"
                                                            style="display: flex; align-items: center;">
                                                            <img draggable="false"
                                                                th:src="@{'/img/'+ ${m?.targetConnector?.config?.connectorType} + '.png'}"
                                                                style="width: 20px; height: 20px; margin-right: 5px;">
                                                            <span th:text="${m?.targetConnector?.name}"
                                                                th:title="${m?.targetConnector?.name}"></span>
                                                            <span th:if="${m?.targetConnector?.running}" th:title="连接正常"
                                                                style="margin-left: 5px;"><i
                                                                    class="fa fa-circle well-sign-green"></i></span>
                                                            <span th:unless="${m?.targetConnector?.running}"
                                                                th:title="连接异常" style="margin-left: 5px;"><i
                                                                    class="fa fa-times-circle-o well-sign-red"></i></span>
                                                        </div>
                                                    </td>

                                                    <!-- 同步类型 -->
                                                    <td th:text="${m?.meta?.model}"></td>

                                                    <!-- 操作 -->
                                                    <td>
                                                        <div class="operation-buttons">
                                                            <!-- 未运行 -->
                                                            <a th:if="${m?.meta?.state ne 1}"
                                                                th:attr="data-url='/mapping/start?id='+${m?.id}"
                                                                href="javascript:;"
                                                                class="btn btn-xs btn-primary margin-right-5"><i
                                                                    class="fa fa-check-circle-o"></i> 启动</a>
                                                            <!-- 运行中 -->
                                                            <a th:if="${m?.meta?.state eq 1}"
                                                                th:attr="data-url='/mapping/stop?id='+${m?.id}"
                                                                href="javascript:;"
                                                                class="btn btn-xs btn-warning margin-right-5"><i
                                                                    class="fa fa-times-circle-o"></i> 停止</a>
                                                            <a href="javascript:;"
                                                                th:attr="data-url='/mapping/page/edit?classOn=0&id='+${m?.id}"
                                                                class="btn btn-xs btn-primary margin-right-5"><i
                                                                    class="fa fa-pencil"></i> 编辑</a>
                                                            <a th:attr="data-url='/mapping/copy?id='+${m?.id}"
                                                                href="javascript:;"
                                                                class="btn btn-xs btn-info margin-right-5"><i
                                                                    class="fa fa-copy"></i> 复制</a>
                                                            <a href="javascript:;"
                                                                th:attr="data-url='/mapping/page/edit?classOn=0&id='+${m?.id}"
                                                                class="btn btn-xs btn-primary margin-right-5"><i
                                                                    class="fa fa-eye"></i> 详情</a>
                                                            <!-- 未运行 -->
                                                            <a th:if="${m?.meta?.state ne 1}"
                                                                th:attr="data-url='/mapping/remove?id='+${m?.id}"
                                                                href="javascript:;" confirm="true"
                                                                confirmMessage="确认删除任务?"
                                                                class="btn btn-xs btn-danger margin-right-5"><i
                                                                    class="fa fa-trash"></i> 删除</a>
                                                            <!-- 重置 -->
                                                            <a th:attr="data-url='/mapping/reset?id='+${m?.id}"
                                                                href="javascript:;" confirm="true"
                                                                confirmMessage="确认重置任务?"
                                                                class="btn btn-xs btn-default margin-right-5"><i
                                                                    class="fa fa-refresh"></i> 重置</a>
                                                            <!-- 日志 -->
                                                            <a th:if="${m?.meta?.fail gt 0}" th:attr="id=${m?.meta?.id}"
                                                                href="javascript:;"
                                                                class="btn btn-xs btn-default queryData"><i
                                                                    class="fa fa-file-text-o"></i> 日志</a>
                                                        </div>
                                                    </td>

                                                    <!-- 创建时间 -->
                                                    <td
                                                        th:text="${#dates.format(m?.updateTime, 'yyyy-MM-dd HH:mm:ss')}">
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 卡片视图 -->
                        <div id="cardView" class="col-md-12" style="display: none;">
                            <div class="row mappingList">
                                <div th:each="m,state : ${mappings}" th:id="${m?.id}" class="col-md-3 col-sm-6 mb-3">
                                    <div class="panel panel-default dbsyncer_block" style="height: 280px; display: flex; flex-direction: column; max-width: 260px;">
                                        <div class="panel-body" style="flex: 1; display: flex; flex-direction: column; font-size: 16px;">
                                            <!-- 任务信息头部 -->
                                            <div class="text-center mb-4">
                                                <h4 th:text="${m?.name}" class="text-primary" style="margin: 0; font-size: 20px;"></h4>
                                                <div id="stateId" class="mt-2" style="font-size: 14px;">
                                                    <span th:if="${m?.meta?.state eq 0}"
                                                        class="label label-info">未运行</span>
                                                    <span th:if="${m?.meta?.state eq 1}"
                                                        class="label label-success">运行中</span>
                                                    <span th:if="${m?.meta?.state eq 2}"
                                                        class="label label-warning">停止中</span>
                                                    <span th:if="${m?.meta?.state eq 3}"
                                                        class="label label-danger">异常</span>
                                                    <!-- 任务异常提示 -->
                                                    <span th:if="${m?.meta?.state eq 3}"
                                                        th:title="${m?.meta?.errorMessage}"
                                                        class="mapping-error-sign" data-toggle="tooltip"
                                                        data-placement="top"><i
                                                            class="fa fa-exclamation-triangle"></i></span>
                                                </div>
                                            </div>

                                            <!-- 同步类型 -->
                                            <div class="mb-4 p-3 border rounded" style="background-color: #f8f9fa; padding: 10px;">
                                                <span class="text-muted">同步类型：</span>
                                                <span th:text="${m?.meta?.model}"></span>
                                            </div>

                                            <!-- 连接信息 -->
                                            <div class="mb-4 flex-grow-1">
                                                <div class="p-3 border rounded mb-3" style="background-color: #f8f9fa; display: flex; align-items: center; padding: 10px; white-space: nowrap; overflow: hidden;">
                                                    <span class="text-muted mr-1">起始源：</span>
                                                    <img draggable="false"
                                                        th:src="@{'/img/'+ ${m?.sourceConnector?.config?.connectorType} + '.png'}"
                                                        style="width: 16px; height: 16px; margin-right: 3px;">
                                                    <span th:text="${m?.sourceConnector?.name}"
                                                        th:title="${m?.sourceConnector?.name}" style="margin-right: 3px; overflow: hidden; text-overflow: ellipsis; flex: 1;"></span>
                                                    <span th:if="${m?.sourceConnector?.running}" th:title="连接正常"
                                                        style="margin-left: 0;"><i
                                                            class="fa fa-circle well-sign-green"></i></span>
                                                    <span th:unless="${m?.sourceConnector?.running}"
                                                        th:title="连接异常" style="margin-left: 0;"><i
                                                            class="fa fa-times-circle-o well-sign-red"></i></span>
                                                </div>

                                                <div class="p-3 border rounded" style="background-color: #f8f9fa; display: flex; align-items: center; padding: 10px; white-space: nowrap; overflow: hidden;">
                                                    <span class="text-muted mr-1">目标源：</span>
                                                    <img draggable="false"
                                                        th:src="@{'/img/'+ ${m?.targetConnector?.config?.connectorType} + '.png'}"
                                                        style="width: 16px; height: 16px; margin-right: 3px;">
                                                    <span th:text="${m?.targetConnector?.name}"
                                                        th:title="${m?.targetConnector?.name}" style="margin-right: 3px; overflow: hidden; text-overflow: ellipsis; flex: 1;"></span>
                                                    <span th:if="${m?.targetConnector?.running}" th:title="连接正常"
                                                        style="margin-left: 0;"><i
                                                            class="fa fa-circle well-sign-green"></i></span>
                                                    <span th:unless="${m?.targetConnector?.running}"
                                                        th:title="连接异常" style="margin-left: 0;"><i
                                                            class="fa fa-times-circle-o well-sign-red"></i></span>
                                                </div>
                                                
                                                <!-- 同步统计信息 -->
                                                <div class="col-md-12 mb-3">
                                                    <table class="table table-hover table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td class="text-left">
                                                                    <span th:text="${m?.meta?.model eq 'full' ? '全量' : (m?.meta?.model eq 'increment' ? '增量' : (m?.meta?.model eq 'full+increment' ? '混合' : m?.meta?.model))}"></span>同步>总数:[[${m?.meta?.total}]]
                                                                    <span th:if="${m?.meta?.syncPhase.code eq 0}">
                                                                        <span th:if="${m?.meta?.counting}">(正在统计中)</span>
                                                                        <span th:if="${m?.meta?.total gt 0 and (m?.meta?.success + m?.meta?.fail) gt 0}">
                                                                            ,进度:[[${#numbers.formatPercent(((m?.meta?.success + m?.meta?.fail) / m?.meta?.total), 2, 2)}]]
                                                                        </span>
                                                                    </span>
                                                                    <span th:if="${m?.meta?.success gt 0}" style="margin-left: 5px; color: green;">成功:[[${m?.meta?.success}]]</span>
                                                                    <span th:if="${m?.meta?.fail gt 0}" style="margin-left: 5px; color: red;">失败:[[${m?.meta?.fail}]]</span>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td class="text-left">
                                                                    启动时间>
                                                                    <span th:if="${m?.meta?.beginTime gt 0}">[[${#dates.format(m?.meta?.beginTime, 'yyyy-MM-dd HH:mm:ss')}]]</span>
                                                                    <span th:unless="${m?.meta?.beginTime gt 0}">-</span>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td class="text-left">
                                                                    耗时>
                                                                    <span th:if="${m?.meta?.beginTime gt 0 and m?.meta?.updateTime gt 0}">
                                                                        <span th:with="seconds=${(m?.meta?.updateTime - m?.meta?.beginTime) / 1000}">
                                                                            <span th:if="${seconds lt 60}" th:text="${seconds + '秒'}" />
                                                                            <span th:if="${seconds ge 60}" th:with="minutes=${seconds / 60}" th:text="${minutes + '分' + (seconds - minutes * 60) + '秒'}" />
                                                                        </span>
                                                                    </span>
                                                                    <span th:unless="${m?.meta?.beginTime gt 0 and m?.meta?.updateTime gt 0}">-</span>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                <!-- 操作按钮 -->
                                                <div class="col-md-12">
                                                    <div class="operation-buttons btn-group btn-group-sm">
                                                        <!-- 未运行 -->
                                                        <a th:if="${m?.meta?.state ne 1}"
                                                            th:attr="data-url='/mapping/start?id='+${m?.id}"
                                                            href="javascript:;"
                                                            class="btn btn-xs btn-primary margin-right-5 mb-1"><i
                                                                class="fa fa-check-circle-o"></i> 启动</a>
                                                        <!-- 运行中 -->
                                                        <a th:if="${m?.meta?.state eq 1}"
                                                            th:attr="data-url='/mapping/stop?id='+${m?.id}"
                                                            href="javascript:;"
                                                            class="btn btn-xs btn-warning margin-right-5 mb-1"><i
                                                                class="fa fa-times-circle-o"></i> 停止</a>
                                                        <a href="javascript:;"
                                                            th:attr="data-url='/mapping/page/edit?classOn=0&id='+${m?.id}"
                                                            class="btn btn-xs btn-primary margin-right-5 mb-1"><i
                                                                class="fa fa-pencil"></i> 编辑</a>
                                                        <a th:attr="data-url='/mapping/copy?id='+${m?.id}"
                                                            href="javascript:;"
                                                            class="btn btn-xs btn-info margin-right-5 mb-1"><i
                                                                class="fa fa-copy"></i> 复制</a>
                                                        <a href="javascript:;"
                                                            th:attr="data-url='/mapping/page/edit?classOn=0&id='+${m?.id}"
                                                            class="btn btn-xs btn-primary margin-right-5 mb-1"><i
                                                                class="fa fa-eye"></i> 详情</a>
                                                        <!-- 未运行 -->
                                                        <a th:if="${m?.meta?.state ne 1}"
                                                            th:attr="data-url='/mapping/remove?id='+${m?.id}"
                                                            href="javascript:;" confirm="true"
                                                            confirmMessage="确认删除任务?"
                                                            class="btn btn-xs btn-danger margin-right-5 mb-1"><i
                                                                class="fa fa-trash"></i> 删除</a>
                                                        <!-- 重置 -->
                                                        <a th:attr="data-url='/mapping/reset?id='+${m?.id}"
                                                            href="javascript:;" confirm="true"
                                                            confirmMessage="确认重置任务?"
                                                            class="btn btn-xs btn-default margin-right-5 mb-1"><i
                                                                class="fa fa-refresh"></i> 重置</a>
                                                        <!-- 日志 -->
                                                        <a th:if="${m?.meta?.fail gt 0}" th:attr="id=${m?.meta?.id}"
                                                            href="javascript:;"
                                                            class="btn btn-xs btn-default queryData margin-right-5 mb-1"><i
                                                                class="fa fa-file-text-o"></i> 日志</a>
                                                    </div>
                                            </div>

                                            <!-- 操作按钮 -->
                                            <div class="mt-auto pt-6">
                                                <div class="operation-buttons" style="display: flex; justify-content: center; gap: 15px;">
                                                    <!-- 未运行 -->
                                                    <a th:if="${m?.meta?.state ne 1}"
                                                        th:attr="data-url='/mapping/start?id='+${m?.id}"
                                                        href="javascript:;"
                                                        class="btn btn-sm btn-primary"><i
                                                            class="fa fa-check-circle-o"></i> 启动</a>
                                                    <!-- 运行中 -->
                                                    <a th:if="${m?.meta?.state eq 1}"
                                                        th:attr="data-url='/mapping/stop?id='+${m?.id}"
                                                        href="javascript:;"
                                                        class="btn btn-sm btn-warning"><i
                                                            class="fa fa-times-circle-o"></i> 停止</a>
                                                    <a href="javascript:;"
                                                        th:attr="data-url='/mapping/page/edit?classOn=0&id='+${m?.id}"
                                                        class="btn btn-sm btn-primary"><i
                                                            class="fa fa-pencil"></i> 编辑</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 任务结束位置 -->
                </div>
            </div>

        </form>
    </div>
</div>

<script th:src="@{/js/index/index.js}"></script>

</html>